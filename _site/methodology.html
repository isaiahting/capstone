<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Data Preview – Accessibility of Eldercare Services in Singapore</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-79108a0fc1995748cbd19a5b0e3e3e7c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Accessibility of Eldercare Services in Singapore</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-content" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Content</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-content">    
        <li class="dropdown-header">Introduction</li>
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-methodology" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Methodology</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-methodology">    
        <li>
    <a class="dropdown-item" href="./methodology/data_preview.html">
 <span class="dropdown-text">Methods</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-results" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Results</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-results">    
        <li class="dropdown-header">Discussion</li>
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./nothing.html"> 
<span class="menu-text">Poster</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">about author.</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview---describe-challenges" id="toc-overview---describe-challenges" class="nav-link active" data-scroll-target="#overview---describe-challenges"><span class="header-section-number">1</span> Overview - describe challenges</a></li>
  <li><a href="#data-acquisition" id="toc-data-acquisition" class="nav-link" data-scroll-target="#data-acquisition"><span class="header-section-number">2</span> Data Acquisition</a>
  <ul class="collapse">
  <li><a href="#population-data" id="toc-population-data" class="nav-link" data-scroll-target="#population-data"><span class="header-section-number">2.1</span> Population Data</a></li>
  <li><a href="#webscraping-of-care-centres" id="toc-webscraping-of-care-centres" class="nav-link" data-scroll-target="#webscraping-of-care-centres"><span class="header-section-number">2.2</span> WebScraping of Care Centres</a></li>
  </ul></li>
  <li><a href="#data-cleaning-manipulation" id="toc-data-cleaning-manipulation" class="nav-link" data-scroll-target="#data-cleaning-manipulation"><span class="header-section-number">3</span> Data Cleaning &amp; Manipulation</a>
  <ul class="collapse">
  <li><a href="#installing-packages" id="toc-installing-packages" class="nav-link" data-scroll-target="#installing-packages"><span class="header-section-number">3.1</span> Installing Packages</a></li>
  <li><a href="#population-data-1" id="toc-population-data-1" class="nav-link" data-scroll-target="#population-data-1"><span class="header-section-number">3.2</span> Population Data</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="header-section-number">3.2.1</span> Overview</a></li>
  <li><a href="#importing-data" id="toc-importing-data" class="nav-link" data-scroll-target="#importing-data"><span class="header-section-number">3.2.2</span> Importing Data</a></li>
  <li><a href="#checking-for-missing-values" id="toc-checking-for-missing-values" class="nav-link" data-scroll-target="#checking-for-missing-values"><span class="header-section-number">3.2.3</span> Checking for Missing Values</a></li>
  <li><a href="#issue-with-popdata22" id="toc-issue-with-popdata22" class="nav-link" data-scroll-target="#issue-with-popdata22"><span class="header-section-number">3.2.4</span> Issue with <code>POPDATA22</code></a></li>
  <li><a href="#returning-rows-where-pop-is-o" id="toc-returning-rows-where-pop-is-o" class="nav-link" data-scroll-target="#returning-rows-where-pop-is-o"><span class="header-section-number">3.2.5</span> Returning rows where pop is o</a></li>
  <li><a href="#duplicate-check" id="toc-duplicate-check" class="nav-link" data-scroll-target="#duplicate-check"><span class="header-section-number">3.2.6</span> Duplicate Check</a></li>
  <li><a href="#eda-of-population-data" id="toc-eda-of-population-data" class="nav-link" data-scroll-target="#eda-of-population-data"><span class="header-section-number">3.2.7</span> EDA of Population Data</a></li>
  <li><a href="#testing-for-missing-values" id="toc-testing-for-missing-values" class="nav-link" data-scroll-target="#testing-for-missing-values"><span class="header-section-number">3.2.8</span> Testing for Missing Values</a></li>
  <li><a href="#percentage-of-missing-values" id="toc-percentage-of-missing-values" class="nav-link" data-scroll-target="#percentage-of-missing-values"><span class="header-section-number">3.2.9</span> Percentage of Missing Values</a></li>
  <li><a href="#imputation" id="toc-imputation" class="nav-link" data-scroll-target="#imputation"><span class="header-section-number">3.2.10</span> Imputation</a></li>
  <li><a href="#survival-analysis" id="toc-survival-analysis" class="nav-link" data-scroll-target="#survival-analysis"><span class="header-section-number">3.2.11</span> Survival Analysis</a></li>
  <li><a href="#step-2-refined" id="toc-step-2-refined" class="nav-link" data-scroll-target="#step-2-refined"><span class="header-section-number">3.2.12</span> Step 2: Refined</a></li>
  <li><a href="#step-2-refined-by-claude" id="toc-step-2-refined-by-claude" class="nav-link" data-scroll-target="#step-2-refined-by-claude"><span class="header-section-number">3.2.13</span> Step 2 refined by Claude</a></li>
  <li><a href="#step-3-average-the-survival-rates" id="toc-step-3-average-the-survival-rates" class="nav-link" data-scroll-target="#step-3-average-the-survival-rates"><span class="header-section-number">3.2.14</span> Step 3: Average the survival rates</a></li>
  <li><a href="#step-4-forecast-each-year-2025-to-2029" id="toc-step-4-forecast-each-year-2025-to-2029" class="nav-link" data-scroll-target="#step-4-forecast-each-year-2025-to-2029"><span class="header-section-number">3.2.15</span> Step 4: Forecast each year 2025 to 2029</a></li>
  <li><a href="#step-5-loop-over-the-years" id="toc-step-5-loop-over-the-years" class="nav-link" data-scroll-target="#step-5-loop-over-the-years"><span class="header-section-number">3.2.16</span> Step 5: Loop over the years</a></li>
  <li><a href="#final-output-of-population-forecast" id="toc-final-output-of-population-forecast" class="nav-link" data-scroll-target="#final-output-of-population-forecast"><span class="header-section-number">3.2.17</span> Final Output of Population Forecast</a></li>
  </ul></li>
  <li><a href="#mpsz-singapores-master-plan-2019-subzone-boundary" id="toc-mpsz-singapores-master-plan-2019-subzone-boundary" class="nav-link" data-scroll-target="#mpsz-singapores-master-plan-2019-subzone-boundary"><span class="header-section-number">3.3</span> MPSZ: Singapore’s Master Plan 2019 Subzone Boundary</a>
  <ul class="collapse">
  <li><a href="#overview-1" id="toc-overview-1" class="nav-link" data-scroll-target="#overview-1"><span class="header-section-number">3.3.1</span> Overview</a></li>
  <li><a href="#transforming-crs" id="toc-transforming-crs" class="nav-link" data-scroll-target="#transforming-crs"><span class="header-section-number">3.3.2</span> Transforming CRS</a></li>
  <li><a href="#shared-boundaries" id="toc-shared-boundaries" class="nav-link" data-scroll-target="#shared-boundaries"><span class="header-section-number">3.3.3</span> Shared Boundaries</a></li>
  <li><a href="#mpsz-land-use" id="toc-mpsz-land-use" class="nav-link" data-scroll-target="#mpsz-land-use"><span class="header-section-number">3.3.4</span> MPSZ Land Use</a></li>
  <li><a href="#sampling-grid" id="toc-sampling-grid" class="nav-link" data-scroll-target="#sampling-grid"><span class="header-section-number">3.3.5</span> Sampling Grid</a></li>
  <li><a href="#visualing-hex_grids-res" id="toc-visualing-hex_grids-res" class="nav-link" data-scroll-target="#visualing-hex_grids-res"><span class="header-section-number">3.3.6</span> Visualing hex_grids &amp; res</a></li>
  <li><a href="#cross-checking-subzones-in-mpsz-forecast-data." id="toc-cross-checking-subzones-in-mpsz-forecast-data." class="nav-link" data-scroll-target="#cross-checking-subzones-in-mpsz-forecast-data."><span class="header-section-number">3.3.7</span> Cross-checking subzones in MPSZ &amp; Forecast data.</a></li>
  <li><a href="#precursor" id="toc-precursor" class="nav-link" data-scroll-target="#precursor"><span class="header-section-number">3.3.8</span> Precursor</a></li>
  <li><a href="#check-and-transform-crs-to-projected" id="toc-check-and-transform-crs-to-projected" class="nav-link" data-scroll-target="#check-and-transform-crs-to-projected"><span class="header-section-number">3.3.9</span> Check and Transform CRS to Projected</a></li>
  <li><a href="#calculate-the-area-of-each-subzone" id="toc-calculate-the-area-of-each-subzone" class="nav-link" data-scroll-target="#calculate-the-area-of-each-subzone"><span class="header-section-number">3.3.10</span> Calculate the Area of Each Subzone</a></li>
  <li><a href="#intersect-hexagons-with-subzones" id="toc-intersect-hexagons-with-subzones" class="nav-link" data-scroll-target="#intersect-hexagons-with-subzones"><span class="header-section-number">3.3.11</span> Intersect Hexagons with Subzones</a></li>
  <li><a href="#calculate-area-of-each-intersection" id="toc-calculate-area-of-each-intersection" class="nav-link" data-scroll-target="#calculate-area-of-each-intersection"><span class="header-section-number">3.3.12</span> Calculate Area of Each Intersection</a></li>
  <li><a href="#estimate-hexagon-population" id="toc-estimate-hexagon-population" class="nav-link" data-scroll-target="#estimate-hexagon-population"><span class="header-section-number">3.3.13</span> Estimate Hexagon Population</a></li>
  <li><a href="#aggregate-estimated-population-to-each-hexagon" id="toc-aggregate-estimated-population-to-each-hexagon" class="nav-link" data-scroll-target="#aggregate-estimated-population-to-each-hexagon"><span class="header-section-number">3.3.14</span> Aggregate Estimated Population to Each Hexagon</a></li>
  <li><a href="#keeping-original-hexagon-attributes" id="toc-keeping-original-hexagon-attributes" class="nav-link" data-scroll-target="#keeping-original-hexagon-attributes"><span class="header-section-number">3.3.15</span> Keeping original hexagon attributes:</a></li>
  </ul></li>
  <li><a href="#care-centre" id="toc-care-centre" class="nav-link" data-scroll-target="#care-centre"><span class="header-section-number">3.4</span> Care Centre</a>
  <ul class="collapse">
  <li><a href="#overview-2" id="toc-overview-2" class="nav-link" data-scroll-target="#overview-2"><span class="header-section-number">3.4.1</span> Overview</a></li>
  <li><a href="#cursory-view" id="toc-cursory-view" class="nav-link" data-scroll-target="#cursory-view"><span class="header-section-number">3.4.2</span> Cursory View</a></li>
  <li><a href="#deleting-unwanted-codes" id="toc-deleting-unwanted-codes" class="nav-link" data-scroll-target="#deleting-unwanted-codes"><span class="header-section-number">3.4.3</span> Deleting Unwanted Codes</a></li>
  <li><a href="#checking-for-missing-values-1" id="toc-checking-for-missing-values-1" class="nav-link" data-scroll-target="#checking-for-missing-values-1"><span class="header-section-number">3.4.4</span> Checking for Missing Values</a></li>
  <li><a href="#duplicate-check-1" id="toc-duplicate-check-1" class="nav-link" data-scroll-target="#duplicate-check-1"><span class="header-section-number">3.4.5</span> Duplicate Check</a></li>
  <li><a href="#separating-postal-code-from-address" id="toc-separating-postal-code-from-address" class="nav-link" data-scroll-target="#separating-postal-code-from-address"><span class="header-section-number">3.4.6</span> Separating postal code from address</a></li>
  <li><a href="#labelling-dataset" id="toc-labelling-dataset" class="nav-link" data-scroll-target="#labelling-dataset"><span class="header-section-number">3.4.7</span> Labelling Dataset</a></li>
  <li><a href="#append-all-care-centres-into-one-dataset" id="toc-append-all-care-centres-into-one-dataset" class="nav-link" data-scroll-target="#append-all-care-centres-into-one-dataset"><span class="header-section-number">3.4.8</span> Append all Care Centres into one dataset</a></li>
  <li><a href="#transforming-categorical-data-to-binary-indicator" id="toc-transforming-categorical-data-to-binary-indicator" class="nav-link" data-scroll-target="#transforming-categorical-data-to-binary-indicator"><span class="header-section-number">3.4.9</span> Transforming Categorical Data to Binary Indicator</a></li>
  <li><a href="#adding-coordinates-to-care-centre" id="toc-adding-coordinates-to-care-centre" class="nav-link" data-scroll-target="#adding-coordinates-to-care-centre"><span class="header-section-number">3.4.10</span> Adding coordinates to care centre</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis"><span class="header-section-number">4</span> Exploratory Data Analysis</a>
  <ul class="collapse">
  <li><a href="#density-of-care-centre-in-each-subzone" id="toc-density-of-care-centre-in-each-subzone" class="nav-link" data-scroll-target="#density-of-care-centre-in-each-subzone"><span class="header-section-number">4.1</span> Density of Care Centre in Each Subzone</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">5</span> References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Data Preview</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Invalid Date</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">June 5, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="overview---describe-challenges" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Overview - describe challenges</h1>
<p>In this section, we will acquire the data sets from various government open-sources data repository and websites. Thereafter, we will install the necessary R packages and import the data sets. In each data set, we will delve into the necessary checks, issues faced and steps into resolving the issue. Thereafter, exploratory data analysis is done on a micro and macro level. In each proces</p>
</section>
<section id="data-acquisition" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Data Acquisition</h1>
<p>In this research, 3 main spectrum of data will be required for this research, namely the Population Data, Master Plan 2019 Subzone boundary and Care Centres. These datasets are gathered from multiple open-source websites which includes Singapore Department of Statistics, Data.gov.sg, and Agency of Integrated Care.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/data_overview.png" class="img-fluid figure-img"></p>
<figcaption>Figure x: Data Overview</figcaption>
</figure>
</div>
<p>##Singapore Master Plan 2019 Subzone Boundary</p>
<p>The Singapore Master Plan 2019 Planning Subzone Boundary is a ESRI shapefile that is obtained from Data.gov.sg.</p>
<section id="population-data" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="population-data"><span class="header-section-number">2.1</span> Population Data</h2>
<p>The Singapore Resident by Planning Area/Subzone, Single Year of Age and Sex, June 2024 is selected for this</p>
<p>As the version January 2025 will be not be ready in due time for this research project, thus, the version of June 2024 is used.</p>
</section>
<section id="webscraping-of-care-centres" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="webscraping-of-care-centres"><span class="header-section-number">2.2</span> WebScraping of Care Centres</h2>
<p>Due to the lack of a centralised data of all care centres, web scraping is warranted in obtaining the information of the care centres. The geographical locations of the Care Centres alongside the centre names such as Active Ageing Centre, Day Care, Community Rehabilitation Centre, Centre-based Nursing were extracted using a web scraping tool, Web Scraper, available in Chrome web store as Seen in Figure x. As there is no centralised file that consist of the centre names and their locations, the location of each centre has to be manually extracted from the <a href="https://www.aic.sg/care-services/">Care Services</a> webpage of the Agency of Integrated Care as seen in Figure x.</p>
<p>Step 0: Download Web Scraper from Chrome web store</p>
<p>Web Scraper is used as it is free, works reasonably well and available in both Chrome and Firefox web store. In the below steps, Chrome will be the default web browser used.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step0.png" class="img-fluid figure-img"></p>
<figcaption><em>Figure x: Web Scraper</em></figcaption>
</figure>
</div>
<p>Step 1: Navigate to Developer Tools in Chrome Web Browser</p>
<p>After downloading the extension from Chrome Web Store, press onto the menu bar at the right of the browser and locate Developer Tools while onto the website you would like to scrape information from.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step1.png" class="img-fluid figure-img"></p>
<figcaption><em>Figure x: Web Scraper</em></figcaption>
</figure>
</div>
<p>Step 2: Interface for Webscraper</p>
<p>After clicking onto Developer Tools, click onto the Web Scraper in the menu bar (in black). Following which the below interface will appear.</p>
<p><a href="Figure x: Locate Developer Tools"><img src="./metho_images/step2.png" class="img-fluid" width="499"></a></p>
<p>Step 3: Create New Sitemap</p>
<p>Click onto “create new sitemap”, thereafter “Create Sitemap”. Sitemap Name will be the overarching term used for these information; in this instance, it will be AAC. The Start URL will be the HTML link that you would like the information to be scraped from.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step3.png" class="img-fluid figure-img"></p>
<figcaption>Figure x:</figcaption>
</figure>
</div>
<p>Step 4: Add New Selector</p>
<p>After creating a new sitemap, the following interface will appear. Click onto the “Add new selector” to select the information to scrape.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step4.png" class="img-fluid figure-img"></p>
<figcaption>Figure x:</figcaption>
</figure>
</div>
<p>Step 5: Selecting Whole Box</p>
<p>Firstly, the id will be the column name. For Type, select Element Attribute from the drop down selection. Thereafter, press on Select under Selector and select two boxes of each centre as seen in the figure below (the remaining boxes will be highlighted through its intelligent function) and press onto Done Selecting in the green box.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step5.png" class="img-fluid figure-img"></p>
<figcaption>Figure x:</figcaption>
</figure>
</div>
<p>Step 6: Sitemap Interface</p>
<p>After adding a new selector, the sitemap page will appear the selector that you’ve inputted.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step6.png" class="img-fluid figure-img"></p>
<figcaption>Figure x: Step 6 - Create New Sitemap</figcaption>
</figure>
</div>
<p>Step 7: Selecting Name of Care Centre</p>
<p>Firstly, the id will be name (with reference to the name of care centre), serving as the column name. Text will be chosen under Type thereafter press Select under Selector and highlight the first 2 names of the care centres (The remaining care centres will be highlighted through its intelligent function) and press onto Done selecting in the green box. Multiple box will be selected as we would like to scrap multiple names and root parent selector will be root and press onto Save Selector.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step7.png" class="img-fluid figure-img"></p>
<figcaption>Figure x: Step 7 - Selecting Name of Care Centre</figcaption>
</figure>
</div>
<p>Step 8: Create New Sitemap</p>
<p>A popup window will be prompted and Group selectors was selected.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step8.png" class="img-fluid figure-img"></p>
<figcaption>Figure x: Step 8 - Create New Sitemap</figcaption>
</figure>
</div>
<p>Step 9: Selecting Address of Care Centre</p>
<p>Similar to Step 7, the id will be address. Text will be chosen under Type thereafter press Select under Selector and highlight the first 2 addresses of the care centres (Remaining addresses will be highlighted through its intelligent function) and press onto Done selecting in the green box. Multiple box will be selected as we would like to scrap multiple addresses and parent selector will be wrapper_for_main_name (as we grouped selectors in step 8) and press onto Save Selector.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step9.png" class="img-fluid figure-img"></p>
<figcaption>Figure x: Step 9 - Selecting Address of Care Centre</figcaption>
</figure>
</div>
<p>Step 10: Data Preview</p>
<p>Prior to data scraping, the data is previewed in ensuring each name of the care centre is correctly tagged to the address using the main website to verify.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step10.png" class="img-fluid figure-img"></p>
<figcaption>Figure x: Step 10 - Data Preview</figcaption>
</figure>
</div>
<p>Step 11: Commence Scraping</p>
<p>Head over to sitemap aac and click onto Scrape. A new browser will appear indicating that it is in process of scraping. It will be closed automatically once the process has ended.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step11.png" class="img-fluid figure-img"></p>
<figcaption>Figure x: Step 11 - Commence Scraping</figcaption>
</figure>
</div>
<p>Step 11: Export Data</p>
<p>Export data is selected upon clicking sitemap aac. 2 file options are offered: csv and xlsx. The former was chosen as CSV files are simple and portable which doesn’t complicate data processing. Thereafter the data will be downloaded.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step12.png" class="img-fluid figure-img"></p>
<figcaption>Figure x:</figcaption>
</figure>
</div>
<p>Step 11: View CSV File</p>
<p>In ensuring the web scraping successful and accurate, the csv. file is opened and examined.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./metho_images/step13.png" class="img-fluid figure-img"></p>
<figcaption>Figure x: Step 11 - View CSV File</figcaption>
</figure>
</div>
<p>The above steps were repeated for each type of care centre. All of the Care Centre data were extracted on 7th February 2025.</p>
</section>
</section>
<section id="data-cleaning-manipulation" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Data Cleaning &amp; Manipulation</h1>
<section id="installing-packages" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="installing-packages"><span class="header-section-number">3.1</span> Installing Packages</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"></ul>
<div class="tab-content">

</div>
</div>
</section>
<section id="population-data-1" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="population-data-1"><span class="header-section-number">3.2</span> Population Data</h2>
<section id="overview" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">3.2.1</span> Overview</h3>
<p>In this section, a total of 4 population datasets from year 2020 to year 2024 will be used in the analysis. The datasets will be cleaned. Survival analysis will be done in estimating the population for age 60 and above for the period 2025 to 2029.</p>
</section>
<section id="importing-data" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="importing-data"><span class="header-section-number">3.2.2</span> Importing Data</h3>
<p>In importing data, <code>read_csv()</code> and <code>rename_with()</code> of tidyverse package are used to perform column name standardisation by converting all variable names in the respective datasets to lowercase.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Population Data 2024</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Population Data 2023</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">Population Data 2022</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" role="tab" aria-controls="tabset-2-4" aria-selected="false">Population Data 2021</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-5" role="tab" aria-controls="tabset-2-5" aria-selected="false">Population Data 2020</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p><a href="https://www.singstat.gov.sg/-/media/files/find_data/population/statistical_tables/respopagesex2024.ashx">Singapore Residents by Planning Area / Subzone, Single Year of Age and Sex, June 2024</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>popdata24 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/popdata/respopagesex2024.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<p><a href="https://www.singstat.gov.sg/-/media/files/find_data/population/statistical_tables/respopagesex2023.ashx">Singapore Residents by Planning Area / Subzone, Single Year of Age and Sex, June 2023</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>popdata23 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/popdata/respopagesex2023.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<p><a href="https://www.singstat.gov.sg/-/media/files/find_data/population/statistical_tables/respopagesex2022.ashx">Singapore Residents by Planning Area / Subzone, Single Year of Age and Sex, June 2022</a>&nbsp;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>popdata22 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/popdata/respopagesex2022.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>PARSING ERROR*</p>
<pre><code>Warning: One or more parsing issues, call `problems()` on your data frame for details, e.g.:
  dat &lt;- vroom(...)
  problems(dat)Rows: 60424 Columns: 6── Column specification</code></pre>
</div>
</div>
</div>
<div id="tabset-2-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-4-tab">
<p><a href="https://www.singstat.gov.sg/-/media/files/find_data/population/statistical_tables/respopagesex2021.ashx">Singapore Residents by Planning Area / Subzone, Single Year of Age and Sex, June 2021</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>popdata21 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/popdata/respopagesex2021.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-2-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-5-tab">
<p><a href="https://www.singstat.gov.sg/-/media/files/find_data/population/statistical_tables/respopagesex2011to2020.ashx">Singapore Residents by Planning Area / Subzone, Single Year of Age and Sex, June 2011-2020</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>popdata20 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/popdata/respopagesex2011to2020.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">==</span> <span class="dv">2020</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(popdata23)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="checking-for-missing-values" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="checking-for-missing-values"><span class="header-section-number">3.2.3</span> Checking for Missing Values</h3>
<p>To check for missing or null values in the name and address columns of each dataset, the code uses the summarise() function from the dplyr package. The summarise() function computes summary statistics for the specified columns, which in this case are name and address. The across() function is used to apply the sum(is.na(.)) operation to both columns simultaneously, counting the number of missing (NA) values in each column.</p>
<p>The is.na() function checks whether each value in the name and address columns is missing or null, returning TRUE for missing values and FALSE for non-missing values. The sum() function then counts the number of TRUE values, which corresponds to the number of missing values in each column. This process is applied to each dataset (aac, counselling, daycare, dementia, hospice, maintenance, nhrespite, nursing, and rehab). In conclusion it is able to identify the number of missing values in the name and address columns across all datasets, which helps assess the completeness of the data and highlights any issues that may require cleaning or imputation before further analysis. It returns 0 missing values.</p>
<p>Results: We noticed that there are 30 missing values popdata22 specifically under the column pop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>popdata20_missing <span class="ot">&lt;-</span> popdata20 <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata20_missing)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>popdata21_missing <span class="ot">&lt;-</span> popdata21 <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata21_missing)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>popdata22_missing <span class="ot">&lt;-</span> popdata22 <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata22_missing)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>popdata23_missing <span class="ot">&lt;-</span> popdata23 <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata23_missing)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>popdata24_missing <span class="ot">&lt;-</span> popdata24 <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata24_missing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="issue-with-popdata22" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="issue-with-popdata22"><span class="header-section-number">3.2.4</span> Issue with <code>POPDATA22</code></h3>
<p>Using the below code, we are able to see clearly the rows that are affected and in the pop column, it appears as NA. The csv file (respopagesex2022.csv) was opened using excel and each row returned in the below output was then cross checked in excel. Whole numbers with comma appeared in excel. This may be because read_csv() function expects a numeric value (double) in one of the columns, but instead, it found a string (the values in the column are likely formatted with commas, such as “1,020”). This is why the parser is raising an issue earlier on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>na_rows <span class="ot">&lt;-</span> popdata22[<span class="fu">is.na</span>(popdata22<span class="sc">$</span>pop), ]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(na_rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Referencing from <a href="https://stackoverflow.com/questions/1523126/how-to-read-data-when-some-numbers-contain-commas-as-thousand-separator">Stackoverflow</a>, the first line of the code is necessary as it defines a new class called <code>"num.with.commas"</code>. This class is intended to handle numeric values that are stored as strings with commas (e.g., <code>"1,000"</code>). Thereafter, the second line of the code defines a method to convert a <code>character</code> type to the custom <code>"num.with.commas"</code> class.</p>
<ul>
<li><p>The <code>gsub(",", "", from)</code> function removes commas from the string (e.g., <code>"1,000"</code> becomes <code>"1000"</code>)</p></li>
<li><p>The <code>as.numeric()</code> function then converts the cleaned string into a numeric value (e.g., <code>"1000"</code> becomes <code>1000</code>)</p></li>
</ul>
<p>This ensures that numbers with commas are properly converted to numeric values during data import.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setClass</span>(<span class="st">"num.with.commas"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setAs</span>(<span class="st">"character"</span>, <span class="st">"num.with.commas"</span>, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(from) <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">","</span>, <span class="st">""</span>, from) ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The file is then re-imported again and specifically, the column ‘pop’ is parsed as a character field in facilitating the next step in removing commas within the population itself.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>popdata22 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/popdata/respopagesex2022.csv"</span>, </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">col_types =</span> <span class="fu">cols</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">PA =</span> <span class="fu">col_character</span>(),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SZ =</span> <span class="fu">col_character</span>(),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Age =</span> <span class="fu">col_character</span>(),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Sex =</span> <span class="fu">col_character</span>(),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Pop =</span> <span class="fu">col_character</span>(),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Time =</span> <span class="fu">col_number</span>()  <span class="co"># Adjust if necessary</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                      )) <span class="sc">%&gt;%</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As previously stated, commas are present in the ‘pop’ column, hence, <code>mutate()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>popdata22 <span class="ot">&lt;-</span> popdata22 <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pop =</span> <span class="fu">as.numeric</span>(<span class="fu">str_replace_all</span>(pop, <span class="st">","</span>, <span class="st">""</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the below codechunk, it was verified that there is no missing values and the above steps taken were successful.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(popdata22) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">names</span>(popdata22))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>popdata22_missing <span class="ot">&lt;-</span> popdata22 <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata22_missing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the below <code>code chunk a &amp; b</code>, we noticed that it returned two different outputs: <code>90_and_over</code> and <code>90_and_Over</code>. This may explain why the error <code>NAs introduced by coercion</code> was returned.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#code chunk a</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>popdata22 <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">max_age =</span> <span class="fu">max</span>(age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#code chunk b</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>popdata24 <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">max_age =</span> <span class="fu">max</span>(age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Hence, in addressing the above issue, the below code chunk was developed. First, The code defines a function called <code>convert_age</code> that takes a dataframe (<code>df</code>) as input. Inside the function, it modifies the <code>age</code> column using <code>mutate()</code>. It checks each value in the <code>age</code> column to see if it contains either “_and_over” or “_and_Over” (case-insensitive match). When a match is found, it extracts just the numeric part (e.g., “90” from “90_and_over”) using <code>str_extract()</code>. If no match is found, it keeps the original value. The second <code>mutate()</code> converts the cleaned <code>age</code> column to numeric values, ensuring all ages are stored as numbers. The function returns the modified dataframe with standardised age values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>convert_age <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age =</span> <span class="fu">if_else</span>(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(age, <span class="fu">regex</span>(<span class="st">"_and_Over|_and_over"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_extract</span>(age, <span class="st">"</span><span class="sc">\\</span><span class="st">d+"</span>),  <span class="co"># Extract just the numeric part</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>      age</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age =</span> <span class="fu">as.numeric</span>(age))</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>popdata20_c <span class="ot">&lt;-</span> <span class="fu">convert_age</span>(popdata20)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>popdata21_c <span class="ot">&lt;-</span> <span class="fu">convert_age</span>(popdata21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>popdata22_c <span class="ot">&lt;-</span> <span class="fu">convert_age</span>(popdata22)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>popdata23_c <span class="ot">&lt;-</span> <span class="fu">convert_age</span>(popdata23)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>popdata24_c <span class="ot">&lt;-</span> <span class="fu">convert_age</span>(popdata24)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Another layer of confirmation of missing values was executed in ensuring no missing values were returned during the abovementioned process and it returns 0 for each dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>popdata20_missing <span class="ot">&lt;-</span> popdata20_c <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.)))) </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata20_missing)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>popdata21_missing <span class="ot">&lt;-</span> popdata21_c <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.)))) </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata21_missing)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>popdata22_missing <span class="ot">&lt;-</span> popdata22_c <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.)))) </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata22_missing)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>popdata23_missing <span class="ot">&lt;-</span> popdata23_c <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.)))) </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata23_missing)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>popdata24_missing <span class="ot">&lt;-</span> popdata24_c <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(pa,sz,age,sex,pop,time), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.)))) </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(popdata24_missing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="returning-rows-where-pop-is-o" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="returning-rows-where-pop-is-o"><span class="header-section-number">3.2.5</span> Returning rows where pop is o</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Return all rows where 'pop' is exactly 0</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>popdata24_c <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>, pop<span class="sc">==</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>popdata23_c <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>, pop<span class="sc">==</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>popdata22_c <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>, pop<span class="sc">==</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>popdata21_c <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>, pop<span class="sc">==</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>popdata20_c <span class="sc">%&gt;%</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>, pop<span class="sc">==</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="duplicate-check" class="level3" data-number="3.2.6">
<h3 data-number="3.2.6" class="anchored" data-anchor-id="duplicate-check"><span class="header-section-number">3.2.6</span> Duplicate Check</h3>
<p>The code provided checks for duplicate rows in each dataset by grouping the dataset by all columns using group_by_all(). It then filters out the rows that have duplicate combinations of values across all columns using filter(n() &gt; 1). The n() function counts the number of occurrences for each combination of values, and filter(n() &gt; 1) keeps only the rows that appear more than once (i.e., duplicates).</p>
<p>For each dataset, the nrow() function is used to check if there are any rows returned after filtering for duplicates. If there are duplicates (i.e., the number of rows is greater than zero), the dataset with the duplicate rows is returned. However, if no duplicates are found (i.e., nrow() equals zero), the code returns 0 to indicate that there are no duplicates in that dataset.</p>
<p>Thus, the code either returns the rows with duplicate values or 0 if no duplicates are present, providing an indication of whether duplicate entries exist in each dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'aac'</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>popdata20_duplicate <span class="ot">&lt;-</span> popdata20_c <span class="sc">%&gt;%</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(popdata20_duplicate)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'counselling'</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>popdata21_duplicate <span class="ot">&lt;-</span> popdata21_c <span class="sc">%&gt;%</span> </span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(popdata21_duplicate)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'daycare'</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>popdata22_duplicate <span class="ot">&lt;-</span> popdata22_c <span class="sc">%&gt;%</span> </span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(popdata22_duplicate)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'dementia'</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>popdata23_duplicate <span class="ot">&lt;-</span> popdata23_c <span class="sc">%&gt;%</span> </span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(popdata23_duplicate)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'hospice'</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>popdata24_duplicate <span class="ot">&lt;-</span> popdata24_c <span class="sc">%&gt;%</span> </span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(popdata24_duplicate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="eda-of-population-data" class="level3" data-number="3.2.7">
<h3 data-number="3.2.7" class="anchored" data-anchor-id="eda-of-population-data"><span class="header-section-number">3.2.7</span> EDA of Population Data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Step 1: Define a function to filter and aggregate age distribution data</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>get_age_distribution <span class="ot">&lt;-</span> <span class="cf">function</span>(data, <span class="at">min_age =</span> <span class="dv">60</span>, <span class="at">max_age =</span> <span class="dv">90</span>) {</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">&gt;=</span> min_age <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> max_age) <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(time, age, sex) <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">total_pop =</span> <span class="fu">sum</span>(pop), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Step 2: Use the function to process data</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>age_dist <span class="ot">&lt;-</span> <span class="fu">get_age_distribution</span>(popdata20_c)  <span class="co"># Default: ages 60-90</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="do">### Step 3: Plot age distributions by year and sex</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>plot_age_distribution <span class="ot">&lt;-</span> <span class="cf">function</span>(age_data) {</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(age_data, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> total_pop, <span class="at">fill =</span> sex)) <span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>time, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Age Distribution (60-90 Years) by Sex and Year"</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Age"</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Total Population"</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"Sex"</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">60</span>, <span class="dv">90</span>, <span class="at">by =</span> <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the plot</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_age_distribution</span>(age_dist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In generating the population pyramid, the below oko</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#load data</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>get_age_distribution <span class="ot">&lt;-</span> <span class="cf">function</span>(data, <span class="at">min_age =</span> <span class="dv">60</span>, <span class="at">max_age =</span> <span class="dv">90</span>) {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">&gt;=</span> min_age <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> max_age) <span class="sc">%&gt;%</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Standardize sex labels to match your data</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">sex =</span> <span class="fu">factor</span>(sex, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Males"</span>, <span class="st">"Females"</span>))</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(time, age, sex) <span class="sc">%&gt;%</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">total_pop =</span> <span class="fu">sum</span>(pop), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#2020</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>age_dist <span class="ot">&lt;-</span> <span class="fu">get_age_distribution</span>(popdata20_c)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Create population pyramid plot function </span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>plot_population_pyramid <span class="ot">&lt;-</span> <span class="cf">function</span>(age_data, <span class="at">plot_year =</span> <span class="fu">max</span>(age_data<span class="sc">$</span>time)) {</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter and transform data</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  plot_data <span class="ot">&lt;-</span> age_data <span class="sc">%&gt;%</span> </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(time <span class="sc">==</span> plot_year) <span class="sc">%&gt;%</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">total_pop =</span> <span class="fu">ifelse</span>(sex <span class="sc">==</span> <span class="st">"Males"</span>, <span class="sc">-</span>total_pop, total_pop))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate axis limits</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  max_pop <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(plot_data<span class="sc">$</span>total_pop))</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> total_pop, <span class="at">fill =</span> sex)) <span class="sc">+</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">width =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">comma</span>(<span class="fu">abs</span>(x)),</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">6</span>),</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span>max_pop <span class="sc">*</span> <span class="fl">1.1</span>, max_pop <span class="sc">*</span> <span class="fl">1.1</span>)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Males"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>, <span class="st">"Females"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Males"</span> <span class="ot">=</span> <span class="st">"Male"</span>, <span class="st">"Females"</span> <span class="ot">=</span> <span class="st">"Female"</span>) <span class="co"># Optional: display cleaner labels</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Population Pyramid of Age 60 &amp; Above -"</span>, plot_year),</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Age"</span>,</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Population Count"</span>,</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"Gender"</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Generate and save the plot ------------------------------------------------</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>final_plot <span class="ot">&lt;-</span> <span class="fu">plot_population_pyramid</span>(age_dist)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="testing-for-missing-values" class="level3" data-number="3.2.8">
<h3 data-number="3.2.8" class="anchored" data-anchor-id="testing-for-missing-values"><span class="header-section-number">3.2.8</span> Testing for Missing Values</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare means of other variables between zero/non-zero groups</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>pop20_i <span class="sc">%&gt;%</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">zero_pop =</span> (pop <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(age, time), mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="percentage-of-missing-values" class="level3" data-number="3.2.9">
<h3 data-number="3.2.9" class="anchored" data-anchor-id="percentage-of-missing-values"><span class="header-section-number">3.2.9</span> Percentage of Missing Values</h3>
<p>pop20</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>pop20_geri <span class="ot">&lt;-</span> pop20 <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>zero_pop20 <span class="ot">&lt;-</span> pop20 <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pop <span class="sc">==</span> <span class="dv">0</span>, age<span class="sc">&gt;=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">nrow</span>(zero_pop20) <span class="sc">/</span> <span class="fu">nrow</span>(pop20_geri)) <span class="sc">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>pop21</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>pop21_geri <span class="ot">&lt;-</span> pop21 <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>zero_pop21 <span class="ot">&lt;-</span> pop21 <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pop <span class="sc">==</span> <span class="dv">0</span>, age<span class="sc">&gt;=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">nrow</span>(zero_pop21) <span class="sc">/</span> <span class="fu">nrow</span>(pop21_geri)) <span class="sc">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>pop22</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>pop22_geri <span class="ot">&lt;-</span> pop22 <span class="sc">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>zero_pop22 <span class="ot">&lt;-</span> pop22 <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pop <span class="sc">==</span> <span class="dv">0</span>, age<span class="sc">&gt;=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">nrow</span>(zero_pop22) <span class="sc">/</span> <span class="fu">nrow</span>(pop22_geri)) <span class="sc">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>pop23</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>pop23_geri <span class="ot">&lt;-</span> pop23 <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>zero_pop23 <span class="ot">&lt;-</span> pop23 <span class="sc">%&gt;%</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pop <span class="sc">==</span> <span class="dv">0</span>, age<span class="sc">&gt;=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">nrow</span>(zero_pop23) <span class="sc">/</span> <span class="fu">nrow</span>(pop23_geri)) <span class="sc">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>pop24</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>pop24_geri <span class="ot">&lt;-</span> pop24 <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>zero_pop24 <span class="ot">&lt;-</span> pop24 <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pop <span class="sc">==</span> <span class="dv">0</span>, age<span class="sc">&gt;=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">nrow</span>(zero_pop24) <span class="sc">/</span> <span class="fu">nrow</span>(pop24_geri)) <span class="sc">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="imputation" class="level3" data-number="3.2.10">
<h3 data-number="3.2.10" class="anchored" data-anchor-id="imputation"><span class="header-section-number">3.2.10</span> Imputation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create zero indicator</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>pop20_i <span class="ot">&lt;-</span> pop20 <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">zero_pop =</span> (pop <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_pop =</span> <span class="fu">ifelse</span>(pop <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="fu">log</span>(pop), <span class="cn">NA</span>)  <span class="co"># For visualization</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check zero patterns</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>zero_summary <span class="ot">&lt;-</span> pop20_i <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age<span class="sc">&gt;=</span><span class="dv">60</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(pa, sz, age, sex) <span class="sc">%&gt;%</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_zeros =</span> <span class="fu">sum</span>(zero_pop),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop_zeros =</span> <span class="fu">mean</span>(zero_pop),</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize zeros</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(zero_summary, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> prop_zeros, <span class="at">fill =</span> sex)) <span class="sc">+</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>pa) <span class="sc">+</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Proportion of Zero Population by Demographics"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pop20_i, <span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>pop)) <span class="sc">+</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(sex <span class="sc">~</span> age) <span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Population Distribution by Demographics"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="survival-analysis" class="level3" data-number="3.2.11">
<h3 data-number="3.2.11" class="anchored" data-anchor-id="survival-analysis"><span class="header-section-number">3.2.11</span> Survival Analysis</h3>
<p><img src="./metho_images/2020.png" class="img-fluid" alt="Figure x: Population Pyramid 2020"> <img src="./metho_images/2021.png" class="img-fluid" alt="Figure x: Population Pyramid 2021"> <img src="./metho_images/2022.png" class="img-fluid" alt="Figure x: Population Pyramid 2022"> <img src="./metho_images/2023.png" class="img-fluid" alt="Figure x: Population Pyramid 2023"> <img src="./metho_images/2024.png" class="img-fluid" alt="Figure x: Population Pyramid 2024"> ### Survival Analysis from 2025 - 2030</p>
<section id="introduction" class="level4" data-number="3.2.11.1">
<h4 data-number="3.2.11.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">3.2.11.1</span> Introduction</h4>
<p>In this section,</p>
<p>The aim of this is to calculate the sruvival rate, in this instance, death is the event of interest.</p>
<p>As the population data is used, we will assume that the data is non-parametric in nature. <strong>Kaplan-Meier</strong></p>
<p>It is assumed that residents will stay in the same address with in relation to their subzones throughout the study period. Hence, if there is a decrease of population in the subzone, the reasonable explanation of this outcome is death.</p>
<p>This code defines a function called <code>clean_age_column</code> that takes a dataframe (<code>df</code>) as input and processes its <code>age</code> column to ensure consistent numeric values. The function uses the <code>%&gt;%</code> (pipe) operator from the <code>dplyr</code> package to chain a series of data transformations. First, it trims any leading or trailing whitespace from the <code>age</code> column using <code>str_trim</code>. Next, it replaces the label <code>"90_and_over"</code> with <code>"90"</code> to standardize the representation of ages 90 and above. Then, it converts the <code>age</code> column to numeric values using <code>as.numeric</code>, while suppressing any warnings that might arise from non-numeric entries (e.g., empty strings or invalid values). Finally, the function filters out any rows where the <code>age</code> could not be converted to a numeric value (resulting in <code>NA</code>), ensuring only valid numeric ages remain in the dataframe. The cleaned dataframe is then returned as the output. This function is useful for preparing age data for analysis by ensuring uniformity and removing invalid entries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>clean_age_column <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> <span class="fu">str_trim</span>(age),  <span class="co"># Trim whitespace</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> <span class="fu">if_else</span>(age <span class="sc">==</span> <span class="st">"90_and_over"</span>, <span class="st">"90"</span>, age),  <span class="co"># Replace label</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(age))  <span class="co"># Convert safely</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(age))  <span class="co"># Remove rows that still couldn't be converted</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-1-load-data" class="level4" data-number="3.2.11.2">
<h4 data-number="3.2.11.2" class="anchored" data-anchor-id="step-1-load-data"><span class="header-section-number">3.2.11.2</span> Step 1: Load data</h4>
<p>Firstly, we will read the rds file. Thereafter, we will apply `clean_age_column()` function that was defined earlier to the loaded dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>pop20 <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/popdata/refined/popdata20_c.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_age_column</span>()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>pop21 <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/popdata/refined/popdata21_c.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_age_column</span>()</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>pop22 <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/popdata/refined/popdata22_c.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_age_column</span>()</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>pop23 <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/popdata/refined/popdata23_c.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_age_column</span>()</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>pop24 <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/popdata/refined/popdata24_c.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_age_column</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2-compute-survival-rates-for-each-year-to-year-transition" class="level4" data-number="3.2.11.3">
<h4 data-number="3.2.11.3" class="anchored" data-anchor-id="step-2-compute-survival-rates-for-each-year-to-year-transition"><span class="header-section-number">3.2.11.3</span> Step 2: Compute survival rates for each year-to-year transition</h4>
<p>This code defines a function called <code>compute_survival_rate</code> that calculates survival rates between two consecutive time periods (e.g., years) for a population dataset. The function takes two dataframes (<code>df1</code> and <code>df2</code>) as inputs, representing population data from two different time points (e.g., 2020 and 2021).</p>
<p>First, the function filters <code>df1</code> to include only individuals aged <strong>59 to 90</strong>, as survival analysis is often focused on older populations. It then increments the age by 1 (using <code>mutate(age = age + 1)</code>) to align the ages with the next time period (<code>df2</code>). Next, it performs an <strong>inner join</strong> between the modified <code>df1</code> and <code>df2</code> using matching columns (<code>age</code>, <code>sex</code>, <code>pa</code> [possibly a region code], and <code>sz</code>. The join suffixes (<code>_prev</code> and <code>_next</code>) distinguish between the population counts from the two time periods.</p>
<p>After joining, the function computes the <strong>survival rate</strong> (<code>rate</code>) by dividing the population in the later period (<code>pop_next</code>) by the population in the earlier period (<code>pop_prev</code>). Finally, it selects and returns only the relevant columns (<code>pa</code>, <code>sz</code>, <code>age</code>, <code>sex</code>, <code>rate</code>, <code>pop_prev</code>, <code>pop_next</code>) for further analysis.</p>
<p>In summary, this function helps estimate how many people from an initial cohort (in <code>df1</code>) survived into the next period (in <code>df2</code>) by age, sex, and other groupings, providing key insights for demographic or actuarial studies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>compute_survival_rate <span class="ot">&lt;-</span> <span class="cf">function</span>(df1, df2) {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  df1 <span class="sc">%&gt;%</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">59</span> <span class="sc">&amp;</span> age <span class="sc">&lt;</span> <span class="dv">91</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age =</span> age <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(df2, </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"pa"</span>, <span class="st">"sz"</span>),</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_prev"</span>, <span class="st">"_next"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rate =</span> pop_next <span class="sc">/</span> pop_prev) <span class="sc">%&gt;%</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(pa, sz, age, sex, rate, pop_prev, pop_next)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>rates_2020_2021 <span class="ot">&lt;-</span> <span class="fu">compute_survival_rate</span>(pop20, pop21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>invalid_rates_2020_2021 <span class="ot">&lt;-</span> rates_2020_2021 <span class="sc">%&gt;%</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">between</span>(rate, <span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">|</span> <span class="fu">is.na</span>(rate) <span class="sc">|</span> <span class="fu">is.infinite</span>(rate))</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>invalid_rates_rows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>rates_2021_2022 <span class="ot">&lt;-</span> <span class="fu">compute_survival_rate</span>(pop21, pop22)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>invalid_rates_2021_2022 <span class="ot">&lt;-</span> rates_2021_2022 <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">between</span>(rate, <span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">|</span> <span class="fu">is.na</span>(rate) <span class="sc">|</span> <span class="fu">is.infinite</span>(rate))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>invalid_rates_rows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>rates_2022_2023 <span class="ot">&lt;-</span> <span class="fu">compute_survival_rate</span>(pop22, pop23)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>invalid_rates_2022_2023 <span class="ot">&lt;-</span> rates_2022_2023 <span class="sc">%&gt;%</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">between</span>(rate, <span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">|</span> <span class="fu">is.na</span>(rate) <span class="sc">|</span> <span class="fu">is.infinite</span>(rate))</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>invalid_rates_rows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>rates_2023_2024 <span class="ot">&lt;-</span> <span class="fu">compute_survival_rate</span>(pop23, pop24)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>invalid_rates_2023_2024 <span class="ot">&lt;-</span> rates_2023_2024 <span class="sc">%&gt;%</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">between</span>(rate, <span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">|</span> <span class="fu">is.na</span>(rate) <span class="sc">|</span> <span class="fu">is.infinite</span>(rate))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>invalid_rates_rows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="step-2-refined" class="level3" data-number="3.2.12">
<h3 data-number="3.2.12" class="anchored" data-anchor-id="step-2-refined"><span class="header-section-number">3.2.12</span> Step 2: Refined</h3>
<p>The function processes survival rate data through four sequential steps, now correctly using dplyr’s grouping mechanism. First, it groups the data by both age and sex, which is crucial because survival rates likely vary significantly across these demographics. Within these groups, it performs three key operations: (1) capping any rates above 1.0 at 1.0 (assuming these represent survival probabilities that shouldn’t exceed 100%), (2) replacing infinite values (which occur when dividing by zero) with the maximum finite rate found in the data, and (3) imputing missing values (NaN) with the median rate for that specific age-sex group. After these grouped operations, it ungroups the data and performs a final safety check, replacing any remaining missing values with 1.0 (a neutral value indicating no change).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>compute_survival_rate <span class="ot">&lt;-</span> <span class="cf">function</span>(df1, df2) {</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  df1 <span class="sc">%&gt;%</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">59</span> <span class="sc">&amp;</span> age <span class="sc">&lt;</span> <span class="dv">91</span>) <span class="sc">%&gt;%</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age =</span> age <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(df2, </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"pa"</span>, <span class="st">"sz"</span>),</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_prev"</span>, <span class="st">"_next"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rate =</span> pop_next <span class="sc">/</span> pop_prev) <span class="sc">%&gt;%</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(pa, sz, age, sex, rate, pop_prev, pop_next)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>refined (tried)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>clean_rates <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">rate_type =</span> <span class="st">"survival"</span>) {</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(age, sex) <span class="sc">%&gt;%</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Handle infinites first - replace with NA for proper imputation</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(rate), <span class="cn">NA</span>, rate),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Cap rates only if they represent probabilities</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="cf">if</span>(rate_type <span class="sc">==</span> <span class="st">"survival"</span> <span class="sc">||</span> rate_type <span class="sc">==</span> <span class="st">"probability"</span>) {</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pmin</span>(<span class="fu">pmax</span>(rate, <span class="dv">0</span>), <span class="dv">1</span>)  <span class="co"># Bound between 0 and 1</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pmax</span>(rate, <span class="dv">0</span>)  <span class="co"># Only ensure non-negative for hazard rates</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Impute missing values with group median</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="fu">median</span>(rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), rate)</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final check - if entire groups had no valid data</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), </span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">if</span>(rate_type <span class="sc">==</span> <span class="st">"survival"</span>) <span class="fl">1.0</span> <span class="cf">else</span> <span class="fl">0.0</span>, </span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>                   rate)</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>clean_rates <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(age, sex) <span class="sc">%&gt;%</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Step 1: Cap rates &gt;1.0 at 1.0 (if survival probability)</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">ifelse</span>(rate <span class="sc">&gt;</span> <span class="fl">1.0</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(rate), <span class="fl">1.0</span>, rate),</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Step 2: Replace Inf with max finite rate</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(rate), <span class="fu">max</span>(rate[<span class="fu">is.finite</span>(rate)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>), rate),</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Step 3: Impute NaN with group median (now works because we're grouped)</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="fu">median</span>(rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), rate)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Fill any remaining NaN with 1.0 (after ungrouping)</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="fl">1.0</span>, rate))</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>claude version</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>clean_survival_rates <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(age, sex) <span class="sc">%&gt;%</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Handle infinites first - replace with NA for proper imputation</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(rate), <span class="cn">NA</span>, rate),</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Bound survival rates between 0 and 1</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(rate, <span class="dv">0</span>), <span class="dv">1</span>),</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Impute missing values with group median</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="fu">median</span>(rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), rate)</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final imputation for any remaining NAs (if entire groups had no valid data)</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="fl">1.0</span>, rate))</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2-refined-by-claude" class="level3" data-number="3.2.13">
<h3 data-number="3.2.13" class="anchored" data-anchor-id="step-2-refined-by-claude"><span class="header-section-number">3.2.13</span> Step 2 refined by Claude</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>compute_survival_rate <span class="ot">&lt;-</span> <span class="cf">function</span>(df1, df2) {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  df1 <span class="sc">%&gt;%</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">59</span> <span class="sc">&amp;</span> age <span class="sc">&lt;</span> <span class="dv">91</span>) <span class="sc">%&gt;%</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age =</span> age <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(df2, </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"pa"</span>, <span class="st">"sz"</span>),</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_prev"</span>, <span class="st">"_next"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rate =</span> pop_next <span class="sc">/</span> pop_prev) <span class="sc">%&gt;%</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(pa, sz, age, sex, rate, pop_prev, pop_next)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stochastic regression imputation function</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>stochastic_impute_rates <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">rate_type =</span> <span class="st">"survival"</span>) {</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Prepare data for imputation</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  df_clean <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Handle infinites and zeros in denominator</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">case_when</span>(</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">is.infinite</span>(rate) <span class="sc">~</span> <span class="cn">NA_real_</span>,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>        pop_prev <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="cn">NA_real_</span>,  <span class="co"># Can't compute rate with zero denominator</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> rate</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create indicator for missingness</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate_missing =</span> <span class="fu">is.na</span>(rate),</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Log transform population for better modeling (add small constant to avoid log(0))</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">log_pop_prev =</span> <span class="fu">log</span>(pop_prev <span class="sc">+</span> <span class="fl">0.1</span>),</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">log_pop_next =</span> <span class="fu">log</span>(pop_next <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Only proceed with imputation if we have missing values</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(df_clean<span class="sc">$</span>rate_missing)) {</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"No missing values found. Returning original data with bounds applied."</span>)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">apply_rate_bounds</span>(df_clean, rate_type))</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Fit regression model for imputation</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use available predictors: age, sex, pa, log_pop_prev</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  complete_cases <span class="ot">&lt;-</span> df_clean <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>rate_missing)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(complete_cases) <span class="sc">&lt;</span> <span class="dv">10</span>) {</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Too few complete cases for reliable regression imputation. Using group medians."</span>)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">fallback_imputation</span>(df_clean, rate_type))</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the regression model</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  imputation_model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (rate_type <span class="sc">==</span> <span class="st">"survival"</span>) {</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Logistic regression for survival rates (bounded 0-1)</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Transform rate to logit scale for modeling</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>      complete_cases_trans <span class="ot">&lt;-</span> complete_cases <span class="sc">%&gt;%</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Ensure rates are in (0,1) for logit transformation</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">rate_bounded =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(rate, <span class="fl">0.001</span>), <span class="fl">0.999</span>),</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">logit_rate =</span> <span class="fu">log</span>(rate_bounded <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> rate_bounded))</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lm</span>(logit_rate <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> pa <span class="sc">+</span> log_pop_prev, </span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">data =</span> complete_cases_trans)</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Linear regression for other rate types</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lm</span>(rate <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> pa <span class="sc">+</span> log_pop_prev, </span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">data =</span> complete_cases)</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Regression model failed. Using group medians."</span>)</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(imputation_model)) {</span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">fallback_imputation</span>(df_clean, rate_type))</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Get model statistics for adding stochastic component</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>  model_sigma <span class="ot">&lt;-</span> <span class="fu">sigma</span>(imputation_model)  <span class="co"># Residual standard error</span></span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 5: Predict missing values</span></span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>  missing_cases <span class="ot">&lt;-</span> df_clean <span class="sc">%&gt;%</span> <span class="fu">filter</span>(rate_missing)</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(missing_cases) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>    predicted_values <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(imputation_model, <span class="at">newdata =</span> missing_cases)</span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="st">"Prediction failed. Using group medians."</span>)</span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(predicted_values)) {</span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add stochastic component (random noise)</span></span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># For reproducibility</span></span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a>      random_error <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(predicted_values), <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> model_sigma)</span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a>      stochastic_predictions <span class="ot">&lt;-</span> predicted_values <span class="sc">+</span> random_error</span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Transform back if using logistic regression</span></span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (rate_type <span class="sc">==</span> <span class="st">"survival"</span>) {</span>
<span id="cb72-60"><a href="#cb72-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert from logit back to probability scale</span></span>
<span id="cb72-61"><a href="#cb72-61" aria-hidden="true" tabindex="-1"></a>        stochastic_predictions <span class="ot">&lt;-</span> <span class="fu">exp</span>(stochastic_predictions) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(stochastic_predictions))</span>
<span id="cb72-62"><a href="#cb72-62" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb72-63"><a href="#cb72-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb72-64"><a href="#cb72-64" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Fill in the missing values</span></span>
<span id="cb72-65"><a href="#cb72-65" aria-hidden="true" tabindex="-1"></a>      df_clean<span class="sc">$</span>rate[df_clean<span class="sc">$</span>rate_missing] <span class="ot">&lt;-</span> stochastic_predictions</span>
<span id="cb72-66"><a href="#cb72-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb72-67"><a href="#cb72-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-68"><a href="#cb72-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-69"><a href="#cb72-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 6: Apply appropriate bounds and return</span></span>
<span id="cb72-70"><a href="#cb72-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">apply_rate_bounds</span>(df_clean, rate_type))</span>
<span id="cb72-71"><a href="#cb72-71" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb72-72"><a href="#cb72-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-73"><a href="#cb72-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to apply rate bounds</span></span>
<span id="cb72-74"><a href="#cb72-74" aria-hidden="true" tabindex="-1"></a>apply_rate_bounds <span class="ot">&lt;-</span> <span class="cf">function</span>(df, rate_type) {</span>
<span id="cb72-75"><a href="#cb72-75" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb72-76"><a href="#cb72-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb72-77"><a href="#cb72-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">case_when</span>(</span>
<span id="cb72-78"><a href="#cb72-78" aria-hidden="true" tabindex="-1"></a>        rate_type <span class="sc">==</span> <span class="st">"survival"</span> <span class="sc">|</span> rate_type <span class="sc">==</span> <span class="st">"probability"</span> <span class="sc">~</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(rate, <span class="dv">0</span>), <span class="dv">1</span>),</span>
<span id="cb72-79"><a href="#cb72-79" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">pmax</span>(rate, <span class="dv">0</span>)  <span class="co"># Only ensure non-negative for hazard rates</span></span>
<span id="cb72-80"><a href="#cb72-80" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb72-81"><a href="#cb72-81" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb72-82"><a href="#cb72-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>rate_missing, <span class="sc">-</span>log_pop_prev, <span class="sc">-</span>log_pop_next)  <span class="co"># Remove helper columns</span></span>
<span id="cb72-83"><a href="#cb72-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-84"><a href="#cb72-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-85"><a href="#cb72-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Fallback function using group medians when regression fails</span></span>
<span id="cb72-86"><a href="#cb72-86" aria-hidden="true" tabindex="-1"></a>fallback_imputation <span class="ot">&lt;-</span> <span class="cf">function</span>(df, rate_type) {</span>
<span id="cb72-87"><a href="#cb72-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Using fallback group median imputation."</span>)</span>
<span id="cb72-88"><a href="#cb72-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-89"><a href="#cb72-89" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb72-90"><a href="#cb72-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(age, sex) <span class="sc">%&gt;%</span></span>
<span id="cb72-91"><a href="#cb72-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb72-92"><a href="#cb72-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">ifelse</span>(rate_missing, <span class="fu">median</span>(rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), rate)</span>
<span id="cb72-93"><a href="#cb72-93" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb72-94"><a href="#cb72-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-95"><a href="#cb72-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final check - if entire groups had no valid data</span></span>
<span id="cb72-96"><a href="#cb72-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb72-97"><a href="#cb72-97" aria-hidden="true" tabindex="-1"></a>      <span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), </span>
<span id="cb72-98"><a href="#cb72-98" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">ifelse</span>(rate_type <span class="sc">==</span> <span class="st">"survival"</span>, <span class="fl">1.0</span>, <span class="fl">0.0</span>), </span>
<span id="cb72-99"><a href="#cb72-99" aria-hidden="true" tabindex="-1"></a>                   rate)</span>
<span id="cb72-100"><a href="#cb72-100" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb72-101"><a href="#cb72-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>rate_missing, <span class="sc">-</span>log_pop_prev, <span class="sc">-</span>log_pop_next)</span>
<span id="cb72-102"><a href="#cb72-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-103"><a href="#cb72-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-104"><a href="#cb72-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Updated main function (replaces your clean_rates function)</span></span>
<span id="cb72-105"><a href="#cb72-105" aria-hidden="true" tabindex="-1"></a>clean_rates <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">rate_type =</span> <span class="st">"survival"</span>) {</span>
<span id="cb72-106"><a href="#cb72-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stochastic_impute_rates</span>(df, rate_type)</span>
<span id="cb72-107"><a href="#cb72-107" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-108"><a href="#cb72-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-109"><a href="#cb72-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb72-110"><a href="#cb72-110" aria-hidden="true" tabindex="-1"></a><span class="co"># survival_rates &lt;- compute_survival_rate(pop20_t1, pop20_t2)</span></span>
<span id="cb72-111"><a href="#cb72-111" aria-hidden="true" tabindex="-1"></a><span class="co"># clean_survival_rates &lt;- clean_rates(survival_rates, rate_type = "survival")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>rates_2020_2021 <span class="ot">&lt;-</span> <span class="fu">compute_survival_rate</span>(pop20, pop21) <span class="sc">%&gt;%</span> <span class="fu">clean_rates</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>rates_2021_2022 <span class="ot">&lt;-</span> <span class="fu">compute_survival_rate</span>(pop21, pop22) <span class="sc">%&gt;%</span> <span class="fu">clean_rates</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>rates_2022_2023 <span class="ot">&lt;-</span> <span class="fu">compute_survival_rate</span>(pop22, pop23) <span class="sc">%&gt;%</span> <span class="fu">clean_rates</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>rates_2023_2024 <span class="ot">&lt;-</span> <span class="fu">compute_survival_rate</span>(pop23, pop24) <span class="sc">%&gt;%</span> <span class="fu">clean_rates</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3-average-the-survival-rates" class="level3" data-number="3.2.14">
<h3 data-number="3.2.14" class="anchored" data-anchor-id="step-3-average-the-survival-rates"><span class="header-section-number">3.2.14</span> Step 3: Average the survival rates</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>avg_survival_rates <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  rates_2020_2021,</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  rates_2021_2022,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  rates_2022_2023,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  rates_2023_2024</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age, sex, pa, sz) <span class="sc">%&gt;%</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg_rate =</span> <span class="fu">mean</span>(rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4-forecast-each-year-2025-to-2029" class="level3" data-number="3.2.15">
<h3 data-number="3.2.15" class="anchored" data-anchor-id="step-4-forecast-each-year-2025-to-2029"><span class="header-section-number">3.2.15</span> Step 4: Forecast each year 2025 to 2029</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>forecast_year <span class="ot">&lt;-</span> <span class="cf">function</span>(base_pop, rates, year) {</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  next_pop <span class="ot">&lt;-</span> base_pop <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">59</span> <span class="sc">&amp;</span> age <span class="sc">&lt;</span> <span class="dv">90</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age =</span> age <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(rates, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"pa"</span>, <span class="st">"sz"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pop =</span> pop <span class="sc">*</span> avg_rate) <span class="sc">%&gt;%</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(age, sex, pa, sz, pop)</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle 90+</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  age_89 <span class="ot">&lt;-</span> base_pop <span class="sc">%&gt;%</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">==</span> <span class="dv">89</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sex, pa, sz, pop) <span class="sc">%&gt;%</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age =</span> <span class="dv">90</span>)</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>  age_90plus <span class="ot">&lt;-</span> base_pop <span class="sc">%&gt;%</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">==</span> <span class="dv">90</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sex, pa, sz, pop)</span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>  pop_90 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(age_89, age_90plus) <span class="sc">%&gt;%</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(sex, pa, sz) <span class="sc">%&gt;%</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">age =</span> <span class="dv">90</span>, <span class="at">pop =</span> <span class="fu">sum</span>(pop), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(next_pop, pop_90) <span class="sc">%&gt;%</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> year) <span class="sc">%&gt;%</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(pa, sz, sex, age)</span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5-loop-over-the-years" class="level3" data-number="3.2.16">
<h3 data-number="3.2.16" class="anchored" data-anchor-id="step-5-loop-over-the-years"><span class="header-section-number">3.2.16</span> Step 5: Loop over the years</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List to store forecasts</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>forecast_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>base_pop <span class="ot">&lt;-</span> pop24</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">2025</span><span class="sc">:</span><span class="dv">2029</span>) {</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  next_forecast <span class="ot">&lt;-</span> <span class="fu">forecast_year</span>(base_pop, avg_survival_rates, y)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  forecast_list[[<span class="fu">as.character</span>(y)]] <span class="ot">&lt;-</span> next_forecast</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  base_pop <span class="ot">&lt;-</span> next_forecast <span class="sc">%&gt;%</span> <span class="fu">select</span>(pa, sz, age, sex,  pop)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="final-output-of-population-forecast" class="level3" data-number="3.2.17">
<h3 data-number="3.2.17" class="anchored" data-anchor-id="final-output-of-population-forecast"><span class="header-section-number">3.2.17</span> Final Output of Population Forecast</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>all_forecasts <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(forecast_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>pivoted_data <span class="ot">&lt;-</span> all_forecasts <span class="sc">%&gt;%</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> year,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> pop,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"aged_"</span>,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">"aged_{year}"</span>,</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>pivoted_data <span class="ot">&lt;-</span> all_forecasts <span class="sc">%&gt;%</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> year,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> pop,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"aged_"</span>,</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">"aged_{year}"</span>,</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fn =</span> <span class="fu">list</span>(<span class="at">pop =</span> list)  <span class="co"># Keeps multiple values as lists</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>pivot_data <span class="ot">&lt;-</span> all_forecasts <span class="sc">%&gt;%</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> year,    <span class="co"># Pivot based on the 'label' column</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"aged_"</span>,</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue =</span> <span class="st">"aged_{year}"</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>REGRESSION</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create missing indicators for both columns</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>check_missing_data <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  df_check <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_prev_missing =</span> <span class="fu">is.na</span>(pop_prev) <span class="sc">|</span> pop_prev <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_next_missing =</span> <span class="fu">is.na</span>(pop_next) <span class="sc">|</span> pop_next <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">any_missing =</span> pop_prev_missing <span class="sc">|</span> pop_next_missing</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Visualize missing patterns</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  missing_pattern <span class="ot">&lt;-</span> df_check <span class="sc">%&gt;%</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(pop_prev, pop_next, age, sex, pa, sz) <span class="sc">%&gt;%</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_prev =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(pop_prev) <span class="sc">|</span> pop_prev <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, pop_prev),</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_next =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(pop_next) <span class="sc">|</span> pop_next <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, pop_next)</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>  VIM<span class="sc">::</span><span class="fu">aggr</span>(missing_pattern, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">'navyblue'</span>,<span class="st">'red'</span>), <span class="at">numbers =</span> <span class="cn">TRUE</span>, <span class="at">sortVars =</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test if missingness depends on other variables</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>  missing_test_prev <span class="ot">&lt;-</span> <span class="fu">glm</span>(pop_prev_missing <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> pa, </span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>                          <span class="at">family =</span> binomial, <span class="at">data =</span> df_check)</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>  missing_test_next <span class="ot">&lt;-</span> <span class="fu">glm</span>(pop_next_missing <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> pa, </span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>                          <span class="at">family =</span> binomial, <span class="at">data =</span> df_check)</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">prev_test =</span> <span class="fu">summary</span>(missing_test_prev),</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">next_test =</span> <span class="fu">summary</span>(missing_test_next),</span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">missing_summary =</span> df_check <span class="sc">%&gt;%</span> </span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">prev_zeros =</span> <span class="fu">sum</span>(pop_prev_missing, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">next_zeros =</span> <span class="fu">sum</span>(pop_next_missing, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">both_zeros =</span> <span class="fu">sum</span>(pop_prev_missing <span class="sc">&amp;</span> pop_next_missing, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_obs =</span> <span class="fu">n</span>()</span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the analysis</span></span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a>missing_analysis <span class="ot">&lt;-</span> <span class="fu">check_missing_data</span>(rates_2020_2021)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simpler version that avoids potential package conflicts</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>check_missing_simple <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for zeros and NAs</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  summary_stats <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_rows =</span> <span class="fu">n</span>(),</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_prev_zeros =</span> <span class="fu">sum</span>(pop_prev <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_prev_nas =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(pop_prev)),</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_next_zeros =</span> <span class="fu">sum</span>(pop_next <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_next_nas =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(pop_next)),</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">both_zero =</span> <span class="fu">sum</span>((pop_prev <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> <span class="fu">is.na</span>(pop_prev)) <span class="sc">&amp;</span> </span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>                     (pop_next <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> <span class="fu">is.na</span>(pop_next)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">pct_prev_missing =</span> <span class="fu">round</span>((pop_prev_zeros <span class="sc">+</span> pop_prev_nas) <span class="sc">/</span> total_rows <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>),</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">pct_next_missing =</span> <span class="fu">round</span>((pop_next_zeros <span class="sc">+</span> pop_next_nas) <span class="sc">/</span> total_rows <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>),</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">pct_both_missing =</span> <span class="fu">round</span>(both_zero <span class="sc">/</span> total_rows <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>)</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">"Missing Data Summary:"</span>)</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(summary_stats)</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create missing indicators for modeling</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>  data_with_indicators <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_prev_missing =</span> <span class="fu">is.na</span>(pop_prev) <span class="sc">|</span> pop_prev <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop_next_missing =</span> <span class="fu">is.na</span>(pop_next) <span class="sc">|</span> pop_next <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test if missingness is systematic</span></span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sum</span>(data_with_indicators<span class="sc">$</span>pop_prev_missing) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>    prev_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(pop_prev_missing <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> pa, </span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a>                     <span class="at">family =</span> binomial, <span class="at">data =</span> data_with_indicators)</span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Pop_prev missingness model p-values:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">summary</span>(prev_model)<span class="sc">$</span>coefficients[, <span class="dv">4</span>])</span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sum</span>(data_with_indicators<span class="sc">$</span>pop_next_missing) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a>    next_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(pop_next_missing <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> pa, </span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>                     <span class="at">family =</span> binomial, <span class="at">data =</span> data_with_indicators)</span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Pop_next missingness model p-values:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">summary</span>(next_model)<span class="sc">$</span>coefficients[, <span class="dv">4</span>])</span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_stats)</span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the analysis</span></span>
<span id="cb85-49"><a href="#cb85-49" aria-hidden="true" tabindex="-1"></a>missing_summary <span class="ot">&lt;-</span> <span class="fu">check_missing_simple</span>(rates_2020_2021)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>check_regression_assumptions_both <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter valid data</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  valid_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(pop_prev <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> pop_next <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  zero_prev <span class="ot">&lt;-</span> <span class="fu">sum</span>(data<span class="sc">$</span>pop_prev <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> <span class="fu">is.na</span>(data<span class="sc">$</span>pop_prev), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  zero_next <span class="ot">&lt;-</span> <span class="fu">sum</span>(data<span class="sc">$</span>pop_next <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> <span class="fu">is.na</span>(data<span class="sc">$</span>pop_next), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(valid_data) <span class="sc">&lt;</span> <span class="dv">20</span>) {</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Insufficient valid data for reliable regression imputation"</span>)</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit models</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>  model_prev <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(pop_prev) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> pa, <span class="at">data =</span> valid_data)</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>  model_next <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(pop_next) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> pa, <span class="at">data =</span> valid_data)</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run all tests</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_summary =</span> <span class="fu">list</span>(</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_obs =</span> <span class="fu">nrow</span>(data),</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">valid_obs =</span> <span class="fu">nrow</span>(valid_data),</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">zero_prev =</span> zero_prev,</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">zero_next =</span> zero_next,</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">pct_missing_prev =</span> <span class="fu">round</span>(zero_prev<span class="sc">/</span><span class="fu">nrow</span>(data)<span class="sc">*</span><span class="dv">100</span>, <span class="dv">2</span>),</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">pct_missing_next =</span> <span class="fu">round</span>(zero_next<span class="sc">/</span><span class="fu">nrow</span>(data)<span class="sc">*</span><span class="dv">100</span>, <span class="dv">2</span>)</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">prev_diagnostics =</span> <span class="fu">list</span>(</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">linearity =</span> lmtest<span class="sc">::</span><span class="fu">raintest</span>(model_prev)<span class="sc">$</span>p.value,</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">specification =</span> lmtest<span class="sc">::</span><span class="fu">resettest</span>(model_prev)<span class="sc">$</span>p.value,</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">normality =</span> <span class="fu">shapiro.test</span>(<span class="fu">residuals</span>(model_prev))<span class="sc">$</span>p.value,</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">homoscedasticity =</span> lmtest<span class="sc">::</span><span class="fu">bptest</span>(model_prev)<span class="sc">$</span>p.value,</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">vif_max =</span> <span class="fu">max</span>(car<span class="sc">::</span><span class="fu">vif</span>(model_prev)),</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">r_squared =</span> <span class="fu">summary</span>(model_prev)<span class="sc">$</span>r.squared</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">next_diagnostics =</span> <span class="fu">list</span>(</span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">linearity =</span> lmtest<span class="sc">::</span><span class="fu">raintest</span>(model_next)<span class="sc">$</span>p.value,</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">specification =</span> lmtest<span class="sc">::</span><span class="fu">resettest</span>(model_next)<span class="sc">$</span>p.value,</span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">normality =</span> <span class="fu">shapiro.test</span>(<span class="fu">residuals</span>(model_next))<span class="sc">$</span>p.value,</span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">homoscedasticity =</span> lmtest<span class="sc">::</span><span class="fu">bptest</span>(model_next)<span class="sc">$</span>p.value,</span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">vif_max =</span> <span class="fu">max</span>(car<span class="sc">::</span><span class="fu">vif</span>(model_next)),</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">r_squared =</span> <span class="fu">summary</span>(model_next)<span class="sc">$</span>r.squared</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print comprehensive diagnostics</span></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=== REGRESSION IMPUTATION DIAGNOSTICS ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"DATA SUMMARY:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Total observations:"</span>, results<span class="sc">$</span>data_summary<span class="sc">$</span>total_obs, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Valid observations:"</span>, results<span class="sc">$</span>data_summary<span class="sc">$</span>valid_obs, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Zero/missing pop_prev:"</span>, results<span class="sc">$</span>data_summary<span class="sc">$</span>zero_prev, </span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>      <span class="st">"("</span>, results<span class="sc">$</span>data_summary<span class="sc">$</span>pct_missing_prev, <span class="st">"%)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Zero/missing pop_next:"</span>, results<span class="sc">$</span>data_summary<span class="sc">$</span>zero_next, </span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>      <span class="st">"("</span>, results<span class="sc">$</span>data_summary<span class="sc">$</span>pct_missing_next, <span class="st">"%)</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function to print diagnostics</span></span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a>  print_diagnostics <span class="ot">&lt;-</span> <span class="cf">function</span>(diag, var_name) {</span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste0</span>(var_name, <span class="st">" DIAGNOSTICS:</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Linearity (Rainbow test):"</span>, <span class="fu">round</span>(diag<span class="sc">$</span>linearity, <span class="dv">4</span>), </span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(diag<span class="sc">$</span>linearity <span class="sc">&gt;</span> <span class="fl">0.05</span>, <span class="st">" ✓"</span>, <span class="st">" ✗"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Specification (RESET test):"</span>, <span class="fu">round</span>(diag<span class="sc">$</span>specification, <span class="dv">4</span>),</span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(diag<span class="sc">$</span>specification <span class="sc">&gt;</span> <span class="fl">0.05</span>, <span class="st">" ✓"</span>, <span class="st">" ✗"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Normality (Shapiro test):"</span>, <span class="fu">round</span>(diag<span class="sc">$</span>normality, <span class="dv">4</span>),</span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(diag<span class="sc">$</span>normality <span class="sc">&gt;</span> <span class="fl">0.05</span>, <span class="st">" ✓"</span>, <span class="st">" ✗"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Homoscedasticity (BP test):"</span>, <span class="fu">round</span>(diag<span class="sc">$</span>homoscedasticity, <span class="dv">4</span>),</span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(diag<span class="sc">$</span>homoscedasticity <span class="sc">&gt;</span> <span class="fl">0.05</span>, <span class="st">" ✓"</span>, <span class="st">" ✗"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Max VIF:"</span>, <span class="fu">round</span>(diag<span class="sc">$</span>vif_max, <span class="dv">2</span>),</span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(diag<span class="sc">$</span>vif_max <span class="sc">&lt;</span> <span class="dv">5</span>, <span class="st">" ✓"</span>, <span class="st">" ✗"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"R-squared:"</span>, <span class="fu">round</span>(diag<span class="sc">$</span>r_squared, <span class="dv">3</span>), </span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(diag<span class="sc">$</span>r_squared <span class="sc">&gt;</span> <span class="fl">0.3</span>, <span class="st">" ✓"</span>, <span class="st">" ✗"</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print_diagnostics</span>(results<span class="sc">$</span>prev_diagnostics, <span class="st">"POP_PREV"</span>)</span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print_diagnostics</span>(results<span class="sc">$</span>next_diagnostics, <span class="st">"POP_NEXT"</span>)</span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Overall recommendation</span></span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a>  prev_pass <span class="ot">&lt;-</span> <span class="fu">all</span>(<span class="fu">c</span>(results<span class="sc">$</span>prev_diagnostics<span class="sc">$</span>linearity <span class="sc">&gt;</span> <span class="fl">0.05</span>,</span>
<span id="cb86-77"><a href="#cb86-77" aria-hidden="true" tabindex="-1"></a>                     results<span class="sc">$</span>prev_diagnostics<span class="sc">$</span>specification <span class="sc">&gt;</span> <span class="fl">0.05</span>,</span>
<span id="cb86-78"><a href="#cb86-78" aria-hidden="true" tabindex="-1"></a>                     results<span class="sc">$</span>prev_diagnostics<span class="sc">$</span>vif_max <span class="sc">&lt;</span> <span class="dv">5</span>,</span>
<span id="cb86-79"><a href="#cb86-79" aria-hidden="true" tabindex="-1"></a>                     results<span class="sc">$</span>prev_diagnostics<span class="sc">$</span>r_squared <span class="sc">&gt;</span> <span class="fl">0.2</span>))</span>
<span id="cb86-80"><a href="#cb86-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-81"><a href="#cb86-81" aria-hidden="true" tabindex="-1"></a>  next_pass <span class="ot">&lt;-</span> <span class="fu">all</span>(<span class="fu">c</span>(results<span class="sc">$</span>next_diagnostics<span class="sc">$</span>linearity <span class="sc">&gt;</span> <span class="fl">0.05</span>,</span>
<span id="cb86-82"><a href="#cb86-82" aria-hidden="true" tabindex="-1"></a>                     results<span class="sc">$</span>next_diagnostics<span class="sc">$</span>specification <span class="sc">&gt;</span> <span class="fl">0.05</span>,</span>
<span id="cb86-83"><a href="#cb86-83" aria-hidden="true" tabindex="-1"></a>                     results<span class="sc">$</span>next_diagnostics<span class="sc">$</span>vif_max <span class="sc">&lt;</span> <span class="dv">5</span>,</span>
<span id="cb86-84"><a href="#cb86-84" aria-hidden="true" tabindex="-1"></a>                     results<span class="sc">$</span>next_diagnostics<span class="sc">$</span>r_squared <span class="sc">&gt;</span> <span class="fl">0.2</span>))</span>
<span id="cb86-85"><a href="#cb86-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-86"><a href="#cb86-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"RECOMMENDATION:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-87"><a href="#cb86-87" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(prev_pass <span class="sc">&amp;&amp;</span> next_pass) {</span>
<span id="cb86-88"><a href="#cb86-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"✓ Regression imputation appropriate for both variables</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-89"><a href="#cb86-89" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(prev_pass <span class="sc">||</span> next_pass) {</span>
<span id="cb86-90"><a href="#cb86-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"⚠ Regression imputation appropriate for"</span>, </span>
<span id="cb86-91"><a href="#cb86-91" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(prev_pass, <span class="st">"pop_prev"</span>, <span class="st">"pop_next"</span>), <span class="st">"only</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-92"><a href="#cb86-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Consider alternative imputation for"</span>, </span>
<span id="cb86-93"><a href="#cb86-93" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(<span class="sc">!</span>prev_pass, <span class="st">"pop_prev"</span>, <span class="st">"pop_next"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-94"><a href="#cb86-94" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-95"><a href="#cb86-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"✗ Regression imputation not recommended for either variable</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-96"><a href="#cb86-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Consider: Multiple imputation, hot-deck, or median/mean imputation</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb86-97"><a href="#cb86-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-98"><a href="#cb86-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-99"><a href="#cb86-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb86-100"><a href="#cb86-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-101"><a href="#cb86-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-102"><a href="#cb86-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the comprehensive check</span></span>
<span id="cb86-103"><a href="#cb86-103" aria-hidden="true" tabindex="-1"></a>comprehensive_check <span class="ot">&lt;-</span> <span class="fu">check_regression_assumptions_both</span>(rates_2020_2021)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, let's verify your data structure</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(rates_2020_2021)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rates_2020_2021)</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for the required columns</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pop_prev"</span>, <span class="st">"pop_next"</span>, <span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"pa"</span>, <span class="st">"sz"</span>)</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>missing_cols <span class="ot">&lt;-</span> required_cols[<span class="sc">!</span>required_cols <span class="sc">%in%</span> <span class="fu">names</span>(rates_2020_2021)]</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(missing_cols) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Missing columns:"</span>, <span class="fu">paste</span>(missing_cols, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"All required columns present"</span>)</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="mpsz-singapores-master-plan-2019-subzone-boundary" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="mpsz-singapores-master-plan-2019-subzone-boundary"><span class="header-section-number">3.3</span> MPSZ: Singapore’s Master Plan 2019 Subzone Boundary</h2>
<section id="overview-1" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="overview-1"><span class="header-section-number">3.3.1</span> Overview</h3>
<p>Using <code>st_read</code>, the ESRI shapefile was imported and it contains 323 data entries and 15 fields. Each of the data entry consists of a multi-polygon shape, with geospatial coordinates with a geographic coordinate system (GCS) of WGS84. The features of GCS include using a 3D spherical model of earth with coordinates of longitude, latitude and altitude whereas PCS uses a 2D plane model with linear measurements (i.e.&nbsp;metres).</p>
<p>As the data file is in KML version. However, the file doesn’t churn the full details of the Master Plan Boundary</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>mpsz <span class="ot">=</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"data/planningarea/"</span>,</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">layer =</span> <span class="st">"mpsz2019"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using <code>glimpse()</code>, we are able to visualise the columns, column types and properties within the columns. Notably, there are numerous columns that are not needed for this analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(mpsz)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the code chunk below, we use the <code>select()</code>function to pick the columns that are required for the anlaysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>mpsz <span class="ot">&lt;-</span> mpsz <span class="sc">%&gt;%</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(SUBZONE_N, PLN_AREA_N, REGION_N, geometry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(mpsz) <span class="sc">+</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="st">"SUBZONE_N"</span>)  <span class="co"># Horizontal legend</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mpsz[<span class="st">"SUBZONE_N"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="transforming-crs" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="transforming-crs"><span class="header-section-number">3.3.2</span> Transforming CRS</h3>
<p>As the research’s focus is exploring the accessibility of care centres in Singapore, PCS would be appropriate in this context as it measures the distance between the elderly’ residence and the care centre. Thus, in ensuring accurate measurement, the function `st_transform` with a crs of 3414 was used (Kam, 2022) in the code chunk below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>mpsz <span class="ot">&lt;-</span> mpsz <span class="sc">%&gt;%</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">3414</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="shared-boundaries" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="shared-boundaries"><span class="header-section-number">3.3.3</span> Shared Boundaries</h3>
<p>The below codechunk uses <code>st_is_valid</code> in assessing if there are shared boundaries in the <code>mpsz</code> data. This is important as shared boundaries can lead to inconsistent data impacting the research findings. 9 polygons with self-intersection (‘Ring Self-Intersection’) issues were returned.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_is_valid</span>(mpsz, <span class="at">reason =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This code chunk visualises the boundaries that are affected such as the smaller islands outside of Singapore Main Island: P. Ubin, P. Tekong, Sentosa Island</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>invalid_polygons <span class="ot">&lt;-</span> mpsz[<span class="sc">!</span><span class="fu">st_is_valid</span>(mpsz),]</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(invalid_polygons)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In addressing the above point, we will use st_buffer() of sf package to compute a 5-metres buffers around the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>mpsz <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(mpsz, <span class="at">dist =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mpsz-land-use" class="level3" data-number="3.3.4">
<h3 data-number="3.3.4" class="anchored" data-anchor-id="mpsz-land-use"><span class="header-section-number">3.3.4</span> MPSZ Land Use</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>mpsz_land <span class="ot">=</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"data/landuse/"</span>,</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">layer =</span> <span class="st">"mp2019_landuse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(mpsz_land)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_is_valid</span>(mpsz_land, <span class="at">reason =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using <code>unique()</code>, it returns a list of properties in the column <code>LU_DESC</code>. As the focus of the research is accessibility to care centre, all residential aspects will be factored in this research.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(mpsz_land<span class="sc">$</span>LU_DESC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the code chunk below, we use the <code>select()</code>function to pick the columns that are required for the anlaysis. Additionally, <code>filter()</code> the column ‘LU_DESC’ for those words containing ‘residential’ Regular expression was used alongside ignoring captital letters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>mpsz_res <span class="ot">&lt;-</span> mpsz_land <span class="sc">%&gt;%</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(LU_DESC, geometry) <span class="sc">%&gt;%</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(LU_DESC, <span class="fu">regex</span>(<span class="st">"residential"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sampling-grid" class="level3" data-number="3.3.5">
<h3 data-number="3.3.5" class="anchored" data-anchor-id="sampling-grid"><span class="header-section-number">3.3.5</span> Sampling Grid</h3>
<p>In measuring spatial accessibility, analytical grids of the sampling fields is used to standardise the means of measurement (Kam, 2022). These analytical grids can be comprised of equilateral triangles, squares or hexagon due to its ability to tessellate (ESRI, 2025). From the code output below, we noticed that the sampling fields in the <code>mpsz_res</code> are not equal for measurement. Therefore, it is imperative to select an appropriate analytical grid in measuring spatial accessibility. Hexagons grids is chosen over triangles and squares due to several factors. Firstly, the shape of a hexagon has a low-perimeter-to-area ratio, hence the edge effect of the grid shape reduces sampling bias. Secondly, when comparing equal area, any point inside a hexagon is closer to the centriod than any given point in an equal-area square or triangle due to the more acute angles of square and triangle versus the hexagon (Burdziej, 2018; ESRI, 2025). This is particular important in this research as we are using the centroid as a proxy in comparing accessibility to the various care centres. The centre of each hexagon is an Origin, additionally, acting as a starting point in ascertaining the shortest distance to the care centres.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_options</span>(<span class="at">check.and.fix =</span> <span class="cn">TRUE</span>)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_options</span>(<span class="at">max.categories =</span> <span class="fu">n_distinct</span>(mpsz_res<span class="sc">$</span>LU_DESC))  <span class="co"># Show all categories</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(mpsz_res) <span class="sc">+</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="st">"LU_DESC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the HealthierSG White Paper 2022, the Ministry of Health has indicated its intention to “expand the network [”care centres”] to 220 by 2025”. Furthermore, through the Ministry’s estimation, 8 in 10 seniors will have a care centre in the vicinity of their homes (Ministry of Health, 2022). Hence, we will assume that the maximum distance to the care centres are 100 metres. Hence, in the code chunk below, <code>st_make_grid</code> from <code>sf</code> package constructed hexagonal grids encompassing the Singapore Master Plan 2019 Planning Subzone Boundary using <code>cellsize</code> that defines the radius of 100 metres and <code>square</code> to be false to generate a hexagonal grid.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>hex_res <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(mpsz_res,</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cellsize =</span> <span class="dv">100</span>,</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">what =</span> <span class="st">"polygon"</span>,</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">square =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sf</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>hex_res<span class="sc">$</span>hex_id <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"H%04d"</span>, <span class="fu">seq_len</span>(<span class="fu">nrow</span>(hex_res))) <span class="sc">%&gt;%</span> <span class="fu">as.factor</span>()</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hex_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualing-hex_grids-res" class="level3" data-number="3.3.6">
<h3 data-number="3.3.6" class="anchored" data-anchor-id="visualing-hex_grids-res"><span class="header-section-number">3.3.6</span> Visualing hex_grids &amp; res</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set tmap mode and options</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)  <span class="co"># Use "view" for interactive map</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_options</span>(<span class="at">check.and.fix =</span> <span class="cn">TRUE</span>)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_options</span>(<span class="at">max.categories =</span> <span class="fu">n_distinct</span>(mpsz_res<span class="sc">$</span>LU_DESC))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the base map with land use</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>base_map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(mpsz_res) <span class="sc">+</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(hex_grid) <span class="sc">+</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="st">"LU_DESC"</span>,</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">palette =</span> <span class="st">"Set3"</span>,</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">title =</span> <span class="st">"Land Use Type"</span>,</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.7</span>,</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">border.col =</span> <span class="st">"gray30"</span>,</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">lwd =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.outside =</span> <span class="cn">TRUE</span>,</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>base_map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add hexagon grid overlay</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>final_map <span class="ot">&lt;-</span> base_map <span class="sc">+</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(hex_grid) <span class="sc">+</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"black"</span>,</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">lwd =</span> <span class="fl">0.5</span>,</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_text</span>(<span class="st">"hex_id"</span>,</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">0.5</span>,</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> <span class="st">"black"</span>,</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">alpha =</span> <span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the map</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>final_map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cross-checking-subzones-in-mpsz-forecast-data." class="level3" data-number="3.3.7">
<h3 data-number="3.3.7" class="anchored" data-anchor-id="cross-checking-subzones-in-mpsz-forecast-data."><span class="header-section-number">3.3.7</span> Cross-checking subzones in MPSZ &amp; Forecast data.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>combined_original_case <span class="ot">&lt;-</span> mpsz <span class="sc">%&gt;%</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(SUBZONE_N) <span class="sc">%&gt;%</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">join_key =</span> <span class="fu">toupper</span>(SUBZONE_N)) <span class="sc">%&gt;%</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    all_forecasts <span class="sc">%&gt;%</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(sz) <span class="sc">%&gt;%</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">join_key =</span> <span class="fu">toupper</span>(sz)),</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"join_key"</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(SUBZONE_N, sz) <span class="sc">%&gt;%</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(SUBZONE_N, sz)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>###Combining MPSZ &amp; Population Forecast</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>mpsz_forecast <span class="ot">&lt;-</span> mpsz <span class="sc">%&gt;%</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(all_forecasts, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"SUBZONE_N"</span> <span class="ot">=</span> <span class="st">"sz"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="precursor" class="level3" data-number="3.3.8">
<h3 data-number="3.3.8" class="anchored" data-anchor-id="precursor"><span class="header-section-number">3.3.8</span> Precursor</h3>
<p>There two sf data layers, namely:</p>
<ul>
<li>hexagon: sf object of hexagonal polygons.</li>
<li>mpsz: sf object of planning subzones. Beside other field, there is a field contains the target population called aged_pop.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please ensure that both layers are in the same CRS (coordinate reference system, 3414 for svy21 ) and use projected units (e.g., meters).</p>
</div>
</div>
</section>
<section id="check-and-transform-crs-to-projected" class="level3" data-number="3.3.9">
<h3 data-number="3.3.9" class="anchored" data-anchor-id="check-and-transform-crs-to-projected"><span class="header-section-number">3.3.9</span> Check and Transform CRS to Projected</h3>
<p>Use the code chunk below to check if the data layers are in svy21 projected coornates system.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(hex_centroids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If it is not projected, use the code chunk to transform the sf data layers into svy21.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>hexagon <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(hexagon, <span class="dv">3414</span>) </span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>mpsz <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(psz, <span class="dv">3414</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-the-area-of-each-subzone" class="level3" data-number="3.3.10">
<h3 data-number="3.3.10" class="anchored" data-anchor-id="calculate-the-area-of-each-subzone"><span class="header-section-number">3.3.10</span> Calculate the Area of Each Subzone</h3>
<p>Next, the code below will compute the area of each polygon in mpsz.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>mpsz <span class="ot">&lt;-</span> mpsz <span class="sc">%&gt;%</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mpsz_area =</span> <span class="fu">st_area</span>(geometry))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="intersect-hexagons-with-subzones" class="level3" data-number="3.3.11">
<h3 data-number="3.3.11" class="anchored" data-anchor-id="intersect-hexagons-with-subzones"><span class="header-section-number">3.3.11</span> Intersect Hexagons with Subzones</h3>
<p>The code chunk below Creates new polygons where hexagons and subzones overlap</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>hex_mpsz_intersection <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(hex_centroids, mpsz)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-area-of-each-intersection" class="level3" data-number="3.3.12">
<h3 data-number="3.3.12" class="anchored" data-anchor-id="calculate-area-of-each-intersection"><span class="header-section-number">3.3.12</span> Calculate Area of Each Intersection</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>hex_mpsz_intersection <span class="ot">&lt;-</span> hex_mpsz_intersection <span class="sc">%&gt;%</span> </span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">intersection_area =</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">st_area</span>(geometry))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="estimate-hexagon-population" class="level3" data-number="3.3.13">
<h3 data-number="3.3.13" class="anchored" data-anchor-id="estimate-hexagon-population"><span class="header-section-number">3.3.13</span> Estimate Hexagon Population</h3>
<p>Assume uniform population density within each subzone. So, the hexagon’s share of the population is:</p>
<p><img src="images/areaproportion.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>hex_mpsz_intersection <span class="ot">&lt;-</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  hex_psz_intersection <span class="sc">%&gt;%</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hex_pop =</span> <span class="fu">as.numeric</span>(</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    intersection_area <span class="sc">/</span> mpsz_area <span class="sc">*</span> </span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>      population))</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co">#to push population up</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="aggregate-estimated-population-to-each-hexagon" class="level3" data-number="3.3.14">
<h3 data-number="3.3.14" class="anchored" data-anchor-id="aggregate-estimated-population-to-each-hexagon"><span class="header-section-number">3.3.14</span> Aggregate Estimated Population to Each Hexagon</h3>
<p>If a hexagon overlaps multiple subzones, sum the estimated populations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>hexagon_population <span class="ot">&lt;-</span> </span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  hex_mpsz_intersection <span class="sc">%&gt;%</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">hex_id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">estimated_population =</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">sum</span>(hex_pop, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="keeping-original-hexagon-attributes" class="level3" data-number="3.3.15">
<h3 data-number="3.3.15" class="anchored" data-anchor-id="keeping-original-hexagon-attributes"><span class="header-section-number">3.3.15</span> Keeping original hexagon attributes:</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>hexagon_final <span class="ot">&lt;-</span> hexagon <span class="sc">%&gt;%</span> </span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hex_id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hexagon_population, </span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="st">"hex_id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>hexagon_final</em> now includes a new column <em>estimated_population</em>, which is the area-weighted population estimate for each hexagon.</p>
</section>
</section>
<section id="care-centre" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="care-centre"><span class="header-section-number">3.4</span> Care Centre</h2>
<section id="overview-2" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="overview-2"><span class="header-section-number">3.4.1</span> Overview</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>aac <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/carecentre/activeageingcentre.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>counselling <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/carecentre/counselling.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>daycare <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/carecentre/daycare.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>dementia <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/carecentre/dementiadaycare.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>hospice <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/carecentre/dayhospice.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>maintenance <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/carecentre/maintenancedaycare.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>nhrespite <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/carecentre/nhrespite.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>nursing <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/carecentre/centrebasednursing.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>rehab <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/carecentre/communityrehabcentre.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cursory-view" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="cursory-view"><span class="header-section-number">3.4.2</span> Cursory View</h3>
<p>Using the glimpse() function, we are able to see that various rows in each data set while sharing the same number of columns. Columns “web-scraper-order” and “web-scraper-start-url” are redundant, thus, will be removed. Additionally, the address includes the postal code and it will seperated from the main street name and block number to facilitate the geospatial mapping thereafter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(aac)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="deleting-unwanted-codes" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="deleting-unwanted-codes"><span class="header-section-number">3.4.3</span> Deleting Unwanted Codes</h3>
<p>The following R code is used to remove the columns “web-scraper-order” and “web-scraper-start-url” from multiple datasets: The select() function from the dplyr package is used to select or remove columns from a data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>aac <span class="ot">&lt;-</span> aac <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="st">"web-scraper-order"</span>, <span class="sc">-</span><span class="st">"web-scraper-start-url"</span>)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>counselling <span class="ot">&lt;-</span> counselling <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="st">"web-scraper-order"</span>, <span class="sc">-</span><span class="st">"web-scraper-start-url"</span>)</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>daycare <span class="ot">&lt;-</span> daycare <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="st">"web-scraper-order"</span>, <span class="sc">-</span><span class="st">"web-scraper-start-url"</span>)</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>dementia <span class="ot">&lt;-</span> dementia <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="st">"web-scraper-order"</span>, <span class="sc">-</span><span class="st">"web-scraper-start-url"</span>)</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>hospice <span class="ot">&lt;-</span> hospice <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="st">"web-scraper-order"</span>, <span class="sc">-</span><span class="st">"web-scraper-start-url"</span>)</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>maintenance <span class="ot">&lt;-</span> maintenance <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="st">"web-scraper-order"</span>, <span class="sc">-</span><span class="st">"web-scraper-start-url"</span>)</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>nhrespite <span class="ot">&lt;-</span> nhrespite <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="st">"web-scraper-order"</span>, <span class="sc">-</span><span class="st">"web-scraper-start-url"</span>)</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>nursing <span class="ot">&lt;-</span> nursing <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="st">"web-scraper-order"</span>, <span class="sc">-</span><span class="st">"web-scraper-start-url"</span>)</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>rehab <span class="ot">&lt;-</span> rehab <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="st">"web-scraper-order"</span>, <span class="sc">-</span><span class="st">"web-scraper-start-url"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After removing the two columns, each data set has two columns, namely name and address only.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(aac)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="checking-for-missing-values-1" class="level3" data-number="3.4.4">
<h3 data-number="3.4.4" class="anchored" data-anchor-id="checking-for-missing-values-1"><span class="header-section-number">3.4.4</span> Checking for Missing Values</h3>
<p>To check for missing or null values in the name and address columns of each dataset, the code uses the summarise() function from the dplyr package. The summarise() function computes summary statistics for the specified columns, which in this case are name and address. The across() function is used to apply the sum(is.na(.)) operation to both columns simultaneously, counting the number of missing (NA) values in each column.</p>
<p>The is.na() function checks whether each value in the name and address columns is missing or null, returning TRUE for missing values and FALSE for non-missing values. The sum() function then counts the number of TRUE values, which corresponds to the number of missing values in each column. This process is applied to each dataset (aac, counselling, daycare, dementia, hospice, maintenance, nhrespite, nursing, and rehab). In conclusion it is able to identify the number of missing values in the name and address columns across all datasets, which helps assess the completeness of the data and highlights any issues that may require cleaning or imputation before further analysis. It returns 0 missing values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Checking for missing or null values in 'name' and 'address' columns</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>aac_missing <span class="ot">&lt;-</span> aac <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>counselling_missing <span class="ot">&lt;-</span> counselling <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>daycare_missing <span class="ot">&lt;-</span> daycare <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>dementia_missing <span class="ot">&lt;-</span> dementia <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>hospice_missing <span class="ot">&lt;-</span> hospice <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>maintenance_missing <span class="ot">&lt;-</span> maintenance <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>nhrespite_missing <span class="ot">&lt;-</span> nhrespite <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>nursing_missing <span class="ot">&lt;-</span> nursing <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>rehab_missing <span class="ot">&lt;-</span> rehab <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="duplicate-check-1" class="level3" data-number="3.4.5">
<h3 data-number="3.4.5" class="anchored" data-anchor-id="duplicate-check-1"><span class="header-section-number">3.4.5</span> Duplicate Check</h3>
<p>The code provided checks for duplicate rows in each dataset (aac, counselling, daycare, dementia, hospice, maintenance, nhrespite, nursing, and rehab) by grouping the dataset by all columns using group_by_all(). It then filters out the rows that have duplicate combinations of values across all columns using filter(n() &gt; 1). The n() function counts the number of occurrences for each combination of values, and filter(n() &gt; 1) keeps only the rows that appear more than once (i.e., duplicates).</p>
<p>For each dataset, the nrow() function is used to check if there are any rows returned after filtering for duplicates. If there are duplicates (i.e., the number of rows is greater than zero), the dataset with the duplicate rows is returned. However, if no duplicates are found (i.e., nrow() equals zero), the code returns 0 to indicate that there are no duplicates in that dataset.</p>
<p>Thus, the code either returns the rows with duplicate values or 0 if no duplicates are present, providing an indication of whether duplicate entries exist in each dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'aac'</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>aac_duplicate <span class="ot">&lt;-</span> aac <span class="sc">%&gt;%</span> </span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'counselling'</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>counselling_duplicate <span class="ot">&lt;-</span> counselling <span class="sc">%&gt;%</span> </span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'daycare'</span></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>daycare_duplicate <span class="ot">&lt;-</span> daycare <span class="sc">%&gt;%</span> </span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'dementia'</span></span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a>dementia_duplicate <span class="ot">&lt;-</span> dementia <span class="sc">%&gt;%</span> </span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-22"><a href="#cb133-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-23"><a href="#cb133-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb133-24"><a href="#cb133-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-25"><a href="#cb133-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'hospice'</span></span>
<span id="cb133-26"><a href="#cb133-26" aria-hidden="true" tabindex="-1"></a>hospice_duplicate <span class="ot">&lt;-</span> hospice <span class="sc">%&gt;%</span> </span>
<span id="cb133-27"><a href="#cb133-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-28"><a href="#cb133-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-29"><a href="#cb133-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb133-30"><a href="#cb133-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-31"><a href="#cb133-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'maintenance'</span></span>
<span id="cb133-32"><a href="#cb133-32" aria-hidden="true" tabindex="-1"></a>maintenance_duplicate <span class="ot">&lt;-</span> maintenance <span class="sc">%&gt;%</span> </span>
<span id="cb133-33"><a href="#cb133-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-34"><a href="#cb133-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-35"><a href="#cb133-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb133-36"><a href="#cb133-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-37"><a href="#cb133-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'nhrespite'</span></span>
<span id="cb133-38"><a href="#cb133-38" aria-hidden="true" tabindex="-1"></a>nhrespite_duplicate <span class="ot">&lt;-</span> nhrespite <span class="sc">%&gt;%</span> </span>
<span id="cb133-39"><a href="#cb133-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-40"><a href="#cb133-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-41"><a href="#cb133-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb133-42"><a href="#cb133-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-43"><a href="#cb133-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'nursing'</span></span>
<span id="cb133-44"><a href="#cb133-44" aria-hidden="true" tabindex="-1"></a>nursing_duplicate <span class="ot">&lt;-</span> nursing <span class="sc">%&gt;%</span> </span>
<span id="cb133-45"><a href="#cb133-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-46"><a href="#cb133-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-47"><a href="#cb133-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb133-48"><a href="#cb133-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-49"><a href="#cb133-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates in 'rehab'</span></span>
<span id="cb133-50"><a href="#cb133-50" aria-hidden="true" tabindex="-1"></a>rehab_duplicate <span class="ot">&lt;-</span> rehab <span class="sc">%&gt;%</span> </span>
<span id="cb133-51"><a href="#cb133-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_all</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-52"><a href="#cb133-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-53"><a href="#cb133-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="separating-postal-code-from-address" class="level3" data-number="3.4.6">
<h3 data-number="3.4.6" class="anchored" data-anchor-id="separating-postal-code-from-address"><span class="header-section-number">3.4.6</span> Separating postal code from address</h3>
<p>The code uses the mutate() function to extract the postal code (last 6 digits) from the address column of the individual dataset and store it in a new column called postal_code. The postal code is then removed from the address column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Active Ageing Centre</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>aac <span class="ot">&lt;-</span><span class="fu">mutate</span>(aac,</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">postal_code =</span> <span class="fu">str_extract</span>(address, <span class="st">"[0-9]{6}$"</span>),  <span class="co"># Extract postal code</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">address =</span> <span class="fu">str_remove</span>(address, <span class="st">"[,]?</span><span class="sc">\\</span><span class="st">s*[0-9]{6}$"</span>)  <span class="co"># Remove postal code from address</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Counselling</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>counselling <span class="ot">&lt;-</span> <span class="fu">mutate</span>(counselling,</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">postal_code =</span> <span class="fu">str_extract</span>(address, <span class="st">"[0-9]{6}$"</span>),</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">address =</span> <span class="fu">str_remove</span>(address, <span class="st">"[,]?</span><span class="sc">\\</span><span class="st">s*[0-9]{6}$"</span>)</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Daycare</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>daycare <span class="ot">&lt;-</span> <span class="fu">mutate</span>(daycare,</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">postal_code =</span> <span class="fu">str_extract</span>(address, <span class="st">"[0-9]{6}$"</span>),</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">address =</span> <span class="fu">str_remove</span>(address, <span class="st">"[,]?</span><span class="sc">\\</span><span class="st">s*[0-9]{6}$"</span>)</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dementia</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>dementia <span class="ot">&lt;-</span> <span class="fu">mutate</span>(dementia,</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">postal_code =</span> <span class="fu">str_extract</span>(address, <span class="st">"[0-9]{6}$"</span>),</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">address =</span> <span class="fu">str_remove</span>(address, <span class="st">"[,]?</span><span class="sc">\\</span><span class="st">s*[0-9]{6}$"</span>)</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Day Hospice</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>hospice <span class="ot">&lt;-</span> <span class="fu">mutate</span>(hospice,</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">postal_code =</span> <span class="fu">str_extract</span>(address, <span class="st">"[0-9]{6}$"</span>),</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">address =</span> <span class="fu">str_remove</span>(address, <span class="st">"[,]?</span><span class="sc">\\</span><span class="st">s*[0-9]{6}$"</span>)</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Maintenance Daycare</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>maintenance <span class="ot">&lt;-</span> <span class="fu">mutate</span>(maintenance,</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">postal_code =</span> <span class="fu">str_extract</span>(address, <span class="st">"[0-9]{6}$"</span>),</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">address =</span> <span class="fu">str_remove</span>(address, <span class="st">"[,]?</span><span class="sc">\\</span><span class="st">s*[0-9]{6}$"</span>)</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NH Respite</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>nhrespite <span class="ot">&lt;-</span> <span class="fu">mutate</span>(nhrespite,</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">postal_code =</span> <span class="fu">str_extract</span>(address, <span class="st">"[0-9]{6}$"</span>),</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">address =</span> <span class="fu">str_remove</span>(address, <span class="st">"[,]?</span><span class="sc">\\</span><span class="st">s*[0-9]{6}$"</span>)</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Centre Based Nursing</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>nursing <span class="ot">&lt;-</span> <span class="fu">mutate</span>(nursing,</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">postal_code =</span> <span class="fu">str_extract</span>(address, <span class="st">"[0-9]{6}$"</span>),</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">address =</span> <span class="fu">str_remove</span>(address, <span class="st">"[,]?</span><span class="sc">\\</span><span class="st">s*[0-9]{6}$"</span>)</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Community Rehab Centre</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>rehab <span class="ot">&lt;-</span> <span class="fu">mutate</span>(rehab,</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">postal_code =</span> <span class="fu">str_extract</span>(address, <span class="st">"[0-9]{6}$"</span>),</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">address =</span> <span class="fu">str_remove</span>(address, <span class="st">"[,]?</span><span class="sc">\\</span><span class="st">s*[0-9]{6}$"</span>)</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Checking for missing or null values in 'name' and 'address' columns</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>aac_missing <span class="ot">&lt;-</span> aac <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address, postal_code), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>counselling_missing <span class="ot">&lt;-</span> counselling <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address, postal_code), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>daycare_missing <span class="ot">&lt;-</span> daycare <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address, postal_code), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>dementia_missing <span class="ot">&lt;-</span> dementia <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address, postal_code), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>hospice_missing <span class="ot">&lt;-</span> hospice <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address, postal_code),<span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>maintenance_missing <span class="ot">&lt;-</span> maintenance <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address, postal_code), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>nhrespite_missing <span class="ot">&lt;-</span> nhrespite <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address, postal_code), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>nursing_missing <span class="ot">&lt;-</span> nursing <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address, postal_code), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>rehab_missing <span class="ot">&lt;-</span> rehab <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(name, address, postal_code), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="labelling-dataset" class="level3" data-number="3.4.7">
<h3 data-number="3.4.7" class="anchored" data-anchor-id="labelling-dataset"><span class="header-section-number">3.4.7</span> Labelling Dataset</h3>
<p>The below code chunk adds a column and naming it as “label” in relation to the name of the dataset hence we are able to identify the type of services provided by the care centres.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>aac <span class="ot">&lt;-</span> aac <span class="sc">%&gt;%</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="st">"aac"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>counselling <span class="ot">&lt;-</span> counselling <span class="sc">%&gt;%</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="st">"counselling"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>daycare <span class="ot">&lt;-</span> daycare <span class="sc">%&gt;%</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="st">"daycare"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>dementia <span class="ot">&lt;-</span> dementia <span class="sc">%&gt;%</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="st">"dementia"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>hospice <span class="ot">&lt;-</span> hospice <span class="sc">%&gt;%</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="st">"hospice"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>maintenance <span class="ot">&lt;-</span> maintenance <span class="sc">%&gt;%</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="st">"maintenance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>nhrespite <span class="ot">&lt;-</span> nhrespite <span class="sc">%&gt;%</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="st">"nhrespite"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>nursing <span class="ot">&lt;-</span> nursing <span class="sc">%&gt;%</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="st">"nursing"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>rehab <span class="ot">&lt;-</span> rehab <span class="sc">%&gt;%</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="st">"rehab"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="append-all-care-centres-into-one-dataset" class="level3" data-number="3.4.8">
<h3 data-number="3.4.8" class="anchored" data-anchor-id="append-all-care-centres-into-one-dataset"><span class="header-section-number">3.4.8</span> Append all Care Centres into one dataset</h3>
<p>The code combines multiple datasets (aac, counselling, daycare, dementia, hospice, maintenance, nhrespite, nursing, and rehab) into a single dataset named c_data using the bind_rows() function. This function appends the rows of each dataset, stacking them vertically, to create one consolidated dataset. The resulting c_data will contain all the rows from the individual datasets, assuming they have the same column structure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>cc_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  aac, </span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  counselling,</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>  daycare,</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>  dementia,</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>  hospice,</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>  maintenance,</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>  nhrespite,</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>  nursing,</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>  rehab,</span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="transforming-categorical-data-to-binary-indicator" class="level3" data-number="3.4.9">
<h3 data-number="3.4.9" class="anchored" data-anchor-id="transforming-categorical-data-to-binary-indicator"><span class="header-section-number">3.4.9</span> Transforming Categorical Data to Binary Indicator</h3>
<p>This code transforms the dataset <code>cc_data</code> from a long format to a wide format by pivoting on the categorical values in the <code>label</code> column, effectively converting them into binary indicator columns. The process begins by removing the <code>address</code> column using <code>select(-address)</code> to exclude it from the transformation. Next, a new column called <code>present</code> is created using <code>mutate(present = 1)</code>, where every row is assigned a value of 1 to indicate the presence of a label. The key reshaping operation is performed using <code>pivot_wider()</code>, which spreads the unique values from the <code>label</code> column into separate columns. The <code>names_from = label</code> argument specifies that the new column names should be derived from the distinct categories in <code>label</code>, while <code>values_from = present</code> fills these new columns with the corresponding 1s from the <code>present</code> column. Any missing combinations (where a particular label does not appear for a given record) are automatically filled with 0s due to the <code>values_fill = list(0)</code> argument. The final output, stored in <code>pivoted_cc_data</code>, is a wider dataframe where each original row now has binary flags (1 or 0) indicating the presence or absence of each label category, making it suitable for analyses that require a one-hot encoded or dummy variable representation of categorical data.</p>
<p>correct code</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>pivoted_cc_data <span class="ot">&lt;-</span> cc_data <span class="sc">%&gt;%</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>address) <span class="sc">%&gt;%</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">present =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span>  <span class="co"># Create a column to indicate presence (1)</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> label,    <span class="co"># Pivot based on the 'label' column</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> present,</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="fu">list</span>(<span class="dv">0</span>)<span class="co"># Use the 'present' column for the values</span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>using arrange(0, we are able to see that that the centres are arranged in alphabetically order and they are similar ones.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(pivoted_cc_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>pivoted_cc_data<span class="sc">$</span>name[<span class="fu">duplicated</span>(pivoted_cc_data<span class="sc">$</span>name)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>duplicate_rows <span class="ot">&lt;-</span> pivoted_cc_data <span class="sc">%&gt;%</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count occurrences of each name</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_count</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for names that appear more than once</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove the count column</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n) <span class="sc">%&gt;%</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Arrange by name for better readability</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(name)</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(duplicate_rows) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(duplicate_rows)</span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"No duplicates found in the 'name' column."</span>)</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adding-coordinates-to-care-centre" class="level3" data-number="3.4.10">
<h3 data-number="3.4.10" class="anchored" data-anchor-id="adding-coordinates-to-care-centre"><span class="header-section-number">3.4.10</span> Adding coordinates to care centre</h3>
<p>This code prepares a list of unique postal codes from a dataset called <code>pivoted_cc_data</code> to be used for geocoding via an API. The line first extracts the <code>postal_code</code> column from the dataframe, then applies <code>unique()</code> to eliminate duplicate postal codes - this optimization reduces the number of API calls needed since the same postal code will return the same coordinates. The <code>sort()</code> function then arranges these unique postal codes in ascending order, which serves two purposes: it makes the list more organized for human review (easier to locate specific codes during debugging or verification), and it may help with processing efficiency when matching the geocoded results back to the original dataset. The resulting sorted unique list is stored in <code>add_list</code>, which can then be passed to a geocoding API (like the OneMap API in Singapore) that typically accepts individual addresses or postal codes rather than entire dataframes. This preprocessing step is crucial because APIs often have rate limits or usage constraints, so minimizing duplicate requests helps maximize efficiency and reduce potential errors or bottlenecks in the geocoding process. The comment “parse a list as API cannot read df” explicitly notes that this conversion from dataframe column to simple list is necessary because the target API expects individual values rather than dataframe structures as input.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>add_list <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(pivoted_cc_data<span class="sc">$</span>postal_code)) <span class="co">#parse a list as API cannot read df</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="co">#unique reduces records to pass to portal</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="co">#sort is used to easier to find geo codes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The below codechunk defines a function called get_coords that takes a list of Singapore postal codes as input and retrieves their geographic coordinates from the OneMap API (a Singapore government mapping service). The function first initializes an empty data frame to store the results. For each postal code in the input list, it makes an HTTP GET request to the OneMap API, which returns the location data in JSON format. The function then processes the response differently depending on how many matches are found: if there’s exactly one match, it extracts those coordinates; if there are multiple matches, it looks for an exact postal code match; and if no matches are found, it records NA values. The valid coordinates (in WGS84 latitude/longitude format) are converted into an sf (simple features) spatial object, which is then transformed to Singapore’s SVY21 projected coordinate system (EPSG:3414). The function extracts these SVY21 coordinates and merges them back into the original data frame, preserving any rows that had invalid or missing coordinates. The final output is a data frame containing the original postal codes, any matching postal codes found, WGS84 coordinates, SVY21 coordinates, and the geometric data as an sf geometry column. This function is particularly useful for geocoding Singapore addresses and preparing spatial data for analysis with Singapore-specific geographic information systems.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>get_coords <span class="ot">&lt;-</span> <span class="cf">function</span>(postal_list){</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a data frame to store all retrieved coordinates</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  postal_coords <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (postal <span class="cf">in</span> postal_list){</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">'https://www.onemap.gov.sg/api/common/elastic/search?'</span>,</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">query=</span><span class="fu">list</span>(<span class="at">searchVal=</span>postal,</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">returnGeom=</span><span class="st">'Y'</span>,</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">getAddrDetails=</span><span class="st">'Y'</span>))</span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">rawToChar</span>(r<span class="sc">$</span>content))</span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>    found <span class="ot">&lt;-</span> data<span class="sc">$</span>found</span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> data<span class="sc">$</span>results</span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new data frame for each postal code</span></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>    new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If single result, append </span></span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (found <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a>      postal_code <span class="ot">&lt;-</span> res<span class="sc">$</span>POSTAL </span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a>      lat <span class="ot">&lt;-</span> res<span class="sc">$</span>LATITUDE</span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a>      lng <span class="ot">&lt;-</span> res<span class="sc">$</span>LONGITUDE</span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a>      new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">postal_code =</span> postal, </span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a>                           <span class="at">postal_found =</span> postal_code, </span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a>                           <span class="at">latitude_wgs84 =</span> lat,</span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a>                           <span class="at">longitude_wgs84 =</span> lng)</span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If multiple results, use the exact postal code match</span></span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (found <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Find exact match for postal code</span></span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a>      res_match <span class="ot">&lt;-</span> res[res<span class="sc">$</span>POSTAL <span class="sc">==</span> postal, ]</span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If exact match found, use it</span></span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">nrow</span>(res_match) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a>        postal_code <span class="ot">&lt;-</span> res_match<span class="sc">$</span>POSTAL[<span class="dv">1</span>]</span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a>        lat <span class="ot">&lt;-</span> res_match<span class="sc">$</span>LATITUDE[<span class="dv">1</span>]</span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a>        lng <span class="ot">&lt;-</span> res_match<span class="sc">$</span>LONGITUDE[<span class="dv">1</span>]</span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a>        new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">postal_code =</span> postal,</span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a>                             <span class="at">postal_found =</span> postal_code,</span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a>                             <span class="at">latitude_wgs84 =</span> lat,</span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a>                             <span class="at">longitude_wgs84 =</span> lng)</span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If no exact match, set as NA</span></span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> {</span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a>        new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">postal_code =</span> postal,</span>
<span id="cb159-46"><a href="#cb159-46" aria-hidden="true" tabindex="-1"></a>                             <span class="at">postal_found =</span> <span class="cn">NA</span>,</span>
<span id="cb159-47"><a href="#cb159-47" aria-hidden="true" tabindex="-1"></a>                             <span class="at">latitude_wgs84 =</span> <span class="cn">NA</span>,</span>
<span id="cb159-48"><a href="#cb159-48" aria-hidden="true" tabindex="-1"></a>                             <span class="at">longitude_wgs84 =</span> <span class="cn">NA</span>)</span>
<span id="cb159-49"><a href="#cb159-49" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb159-50"><a href="#cb159-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-51"><a href="#cb159-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no results found</span></span>
<span id="cb159-52"><a href="#cb159-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb159-53"><a href="#cb159-53" aria-hidden="true" tabindex="-1"></a>      new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">postal_code =</span> postal,</span>
<span id="cb159-54"><a href="#cb159-54" aria-hidden="true" tabindex="-1"></a>                           <span class="at">postal_found =</span> <span class="cn">NA</span>,</span>
<span id="cb159-55"><a href="#cb159-55" aria-hidden="true" tabindex="-1"></a>                           <span class="at">latitude_wgs84 =</span> <span class="cn">NA</span>,</span>
<span id="cb159-56"><a href="#cb159-56" aria-hidden="true" tabindex="-1"></a>                           <span class="at">longitude_wgs84 =</span> <span class="cn">NA</span>)</span>
<span id="cb159-57"><a href="#cb159-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-58"><a href="#cb159-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-59"><a href="#cb159-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the row</span></span>
<span id="cb159-60"><a href="#cb159-60" aria-hidden="true" tabindex="-1"></a>    postal_coords <span class="ot">&lt;-</span> <span class="fu">rbind</span>(postal_coords, new_row)</span>
<span id="cb159-61"><a href="#cb159-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-62"><a href="#cb159-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-63"><a href="#cb159-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to sf object with WGS84 coordinates (EPSG:4326)</span></span>
<span id="cb159-64"><a href="#cb159-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter out rows with NA coordinates first</span></span>
<span id="cb159-65"><a href="#cb159-65" aria-hidden="true" tabindex="-1"></a>  valid_coords <span class="ot">&lt;-</span> postal_coords[<span class="sc">!</span><span class="fu">is.na</span>(postal_coords<span class="sc">$</span>latitude_wgs84) <span class="sc">&amp;</span> </span>
<span id="cb159-66"><a href="#cb159-66" aria-hidden="true" tabindex="-1"></a>                              <span class="sc">!</span><span class="fu">is.na</span>(postal_coords<span class="sc">$</span>longitude_wgs84), ]</span>
<span id="cb159-67"><a href="#cb159-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-68"><a href="#cb159-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(valid_coords) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb159-69"><a href="#cb159-69" aria-hidden="true" tabindex="-1"></a>    coords_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(valid_coords, </span>
<span id="cb159-70"><a href="#cb159-70" aria-hidden="true" tabindex="-1"></a>                         <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude_wgs84"</span>, <span class="st">"latitude_wgs84"</span>),</span>
<span id="cb159-71"><a href="#cb159-71" aria-hidden="true" tabindex="-1"></a>                         <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb159-72"><a href="#cb159-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-73"><a href="#cb159-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform to SVY21 (EPSG:3414)</span></span>
<span id="cb159-74"><a href="#cb159-74" aria-hidden="true" tabindex="-1"></a>    coords_svy21 <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(coords_sf, <span class="dv">3414</span>)</span>
<span id="cb159-75"><a href="#cb159-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-76"><a href="#cb159-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract coordinates</span></span>
<span id="cb159-77"><a href="#cb159-77" aria-hidden="true" tabindex="-1"></a>    coords_matrix <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(coords_svy21)</span>
<span id="cb159-78"><a href="#cb159-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-79"><a href="#cb159-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add SVY21 coordinates back to the original dataframe</span></span>
<span id="cb159-80"><a href="#cb159-80" aria-hidden="true" tabindex="-1"></a>    valid_coords<span class="sc">$</span>longitude <span class="ot">&lt;-</span> coords_matrix[, <span class="dv">1</span>]  <span class="co"># SVY21 X coordinate</span></span>
<span id="cb159-81"><a href="#cb159-81" aria-hidden="true" tabindex="-1"></a>    valid_coords<span class="sc">$</span>latitude <span class="ot">&lt;-</span> coords_matrix[, <span class="dv">2</span>]   <span class="co"># SVY21 Y coordinate</span></span>
<span id="cb159-82"><a href="#cb159-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-83"><a href="#cb159-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-84"><a href="#cb159-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge back with rows that had NA coordinates</span></span>
<span id="cb159-85"><a href="#cb159-85" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">merge</span>(postal_coords, </span>
<span id="cb159-86"><a href="#cb159-86" aria-hidden="true" tabindex="-1"></a>                   valid_coords[<span class="fu">c</span>(<span class="st">"postal_code"</span>, <span class="st">"longitude"</span>, <span class="st">"latitude"</span>)], </span>
<span id="cb159-87"><a href="#cb159-87" aria-hidden="true" tabindex="-1"></a>                   <span class="at">by =</span> <span class="st">"postal_code"</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb159-88"><a href="#cb159-88" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb159-89"><a href="#cb159-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no valid coordinates, add empty SVY21 columns</span></span>
<span id="cb159-90"><a href="#cb159-90" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> postal_coords</span>
<span id="cb159-91"><a href="#cb159-91" aria-hidden="true" tabindex="-1"></a>    result<span class="sc">$</span>longitude <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb159-92"><a href="#cb159-92" aria-hidden="true" tabindex="-1"></a>    result<span class="sc">$</span>latitude <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb159-93"><a href="#cb159-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-94"><a href="#cb159-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-95"><a href="#cb159-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb159-96"><a href="#cb159-96" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code <code>coords &lt;- get_coords(add_list)</code> calls the previously defined <code>get_coords()</code> function to geocode (convert to geographic coordinates) a list of Singapore postal codes stored in <code>add_list</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">get_coords</span>(add_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The below code chunk merges the original dataset (<code>pivoted_cc_data</code>) with the geocoded coordinates (<code>coords</code>) using a left join operation, which preserves all records from the primary dataset while matching and appending geographic data where available using the properties of <code>postal_code</code> in both dataframes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>cc_data_final <span class="ot">&lt;-</span> pivoted_cc_data <span class="sc">%&gt;%</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(coords, </span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">join_by</span>(postal_code <span class="sc">==</span> postal_code)</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>cc_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(cc_data_final,</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="co">#c is use column</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">crs =</span> <span class="dv">3414</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>mpsz_land_fixed <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(mpsz_land)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(mpsz_land_fixed) <span class="sc">+</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(mpsz) <span class="sc">+</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(cc_sf) <span class="sc">+</span></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>() <span class="co">#change to name</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(cc_sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(mpsz)<span class="sc">+</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"DEPENDENCY"</span>, </span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">style =</span> <span class="st">"quantile"</span>, </span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">palette =</span> <span class="st">"Blues"</span>,</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">"Dependency ratio"</span>) <span class="sc">+</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Distribution of Dependency Ratio by planning subzone"</span>,</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.position =</span> <span class="st">"center"</span>,</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.size =</span> <span class="fl">1.2</span>,</span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.height =</span> <span class="fl">0.45</span>, </span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.width =</span> <span class="fl">0.35</span>,</span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">frame =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_compass</span>(<span class="at">type=</span><span class="st">"8star"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_scale_bar</span>() <span class="sc">+</span></span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_grid</span>(<span class="at">alpha =</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_credits</span>(<span class="st">"Source: Planning Sub-zone boundary from Urban Redevelopment Authorithy (URA)</span><span class="sc">\n</span><span class="st"> and Population data from Department of Statistics DOS"</span>, </span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"bottom"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="exploratory-data-analysis" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Exploratory Data Analysis</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmpa_mode</span>(<span class="st">"view"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(mpsz)<span class="sc">+</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tmap_options</span>(<span class="at">check.and.fix =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(condo_resale.res.sf) <span class="sc">+</span>  </span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"MLR_RES"</span>,</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">alpha =</span> <span class="fl">0.6</span>,</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">style=</span><span class="st">"quantile"</span>) <span class="sc">+</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_view</span>(<span class="at">set.zoom.limits =</span> <span class="fu">c</span>(<span class="dv">11</span>,<span class="dv">14</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="density-of-care-centre-in-each-subzone" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="density-of-care-centre-in-each-subzone"><span class="header-section-number">4.1</span> Density of Care Centre in Each Subzone</h2>
<p>refer chapt 1</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>mpsz<span class="sc">$</span><span class="st">`</span><span class="at">CC Count</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="fu">lengths</span>(<span class="fu">st_intersects</span>(mpsz, ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="references" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> References</h1>
<p>Burdziej, J. (2019). Using hexagonal grids and network analysis for spatial accessibility assessment in urban environments-A case study of public amenities in Toruń. Miscellanea Geographica. Regional Studies on Development, 23(2), 99-110.</p>
<p>ESRI. (2025). Why hexagons?. Retrieved on May, 2025 from https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-statistics/h-whyhexagons.htm</p>
<p>Kam, T. S. (2024). R for Geospatial Data Science and Analytics. Retrieved on April 2, 2, 2025 from https://r4gdsa.netlify.app/</p>
<p>Kam, T. S. (2022). GIS for Urban PlanningL QGIS methods. Retrieved on May 2, 2025 from https://gis4urbplan.netlify.app/</p>
<p>Tan, K. (2023). Take-home Exercise 1: Geospatial Analytics for Public Good. Retrieved from <a href="https://isss624-kytjy.netlify.app/take-home_ex/take-home_ex1/the1#background" class="uri">https://isss624-kytjy.netlify.app/take-home_ex/take-home_ex1/the1#background</a></p>
<p>Ministry of Health Singapore. (2022). Healthier SG White Paper. Retrieved from https://file.go.gov.sg/healthiersg-whitepaper-pdf.pdf</p>
<p>Urban Redevelopment Authority. (2023). Master Plan 2019 Planning Area Boundary (No Sea) (2024) [Dataset]. data.gov.sg. Retrieved February 23, 2025 from https://data.gov.sg/datasets/d_6c6d7361dd826d97b91bac914ca6b2ac/view</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>